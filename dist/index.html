#!/bin/env bash
  let displayContent = '';
  
  if (codeMatch) {
    // Extract code content
    const codeToApply = codeMatch[1].trim();
    
    // Create a button to apply the code
    const applyButton = `<button class="small success apply-ai-code" style="margin-top: 10px;">Apply Code Change</button>`;
    displayContent = response.replace(codeMatch[0], `<pre class="language-${currentFileType}" style="max-height: 150px; overflow: auto; border: 1px solid var(--accent); padding: 5px;"><code>${codeToApply}</code></pre>${applyButton}`);
    
    // Setup apply button logic
    setTimeout(() => {
      $('.apply-ai-code').off('click').on('click', function() {
        editor.value = codeToApply;
        recordHistory(editor.value);
        renderEditor(editor.value);
        $(aiResponsePanel).hide();
        updateStatusDisplay('AI code applied successfully.', 'success');
      });
    }, 10);
  } else {
    // Plain text response
    displayContent = response.replace(/\n/g, '<br>');
  }

  aiResponseContent.innerHTML = displayContent;
  $(aiResponsePanel).show();
}

async function runAICodeRequest() {
  const prompt = $('#prompt-input').val().trim();
  if (!prompt) {
    updateStatusDisplay('Please enter a prompt for the AI.', 'warn');
    return;
  }
  
  const code = editor.value;
  $('#prompt-input').val('');

  // Set loading status and disable buttons
  setAIStatus(true, 'Nemodian Processing...', true);
  updateStatusDisplay('Nemodian 2244-1 is processing your request...', 'info');
  showAIResponse('Nemodian 2244-1 is analyzing the code and generating a response. Please wait...');
  
  try {
    // ACTUAL API CALL
    const response = await callGeminiAPI(prompt, code);
    showAIResponse(response);
    updateStatusDisplay('AI response received.', 'success');
    setAIStatus(true, 'Nemodian Online');
  } catch (error) {
    const errorMessage = `AI Request Failed: ${error.message}. Check the console for details.`;
    console.error(errorMessage, error);
    updateStatusDisplay(errorMessage, 'error');
    showAIResponse(`Error: Failed to connect to Nemodian AI. ${error.message}`);
    setAIStatus(false, 'Connection Error: Failed to call API');
  }
}


// --- Event Listeners and Setup ---

// Editor input/scroll synchronization
$(editor).on('input', function() {
  renderEditor(editor.value);
});

$(editor).on('scroll', function() {
  $('.highlighting').scrollTop(editor.scrollTop);
  $('.highlighting').scrollLeft(editor.scrollLeft);
  $(lineGutter).scrollTop(editor.scrollTop);
  // Re-render to update the gutter/highlighting positioning
  renderEditor(editor.value);
});

// Cursor position update
$(editor).on('select keyup mouseup', function() {
  updateStatusDisplay();
});

// Left panel toggle (responsive design)
$('#left-toggle').on('click', function() {
  $('#left-panel').toggleClass('open');
});

// AI Panel Close
$('#close-ai-panel').on('click', function() {
  $(aiResponsePanel).hide();
});

// History & Beautify
$('#btn-undo').on('click', undo);
$('#btn-redo').on('click', redo);
$('#btn-beautify').on('click', function() {
  try {
    const beautifier = getBeautifyOptions(currentFileType);
    const beautifiedCode = beautifier(editor.value, { indent_size: 2, space_in_empty_paren: true });
    editor.value = beautifiedCode;
    recordHistory(editor.value);
    renderEditor(editor.value);
    updateStatusDisplay('Code beautified!', 'success');
  } catch (e) {
    console.error("Beautify failed:", e);
    updateStatusDisplay('Beautify failed. Check console.', 'error');
  }
});

// File Handling
$('#open-file').on('click', function() { $('#file-input').trigger('click'); });
$('#save-file').on('click', function() { saveFile(null); });
$('#save-as').on('click', function() { saveFile(true); });
$('#file-input').on('change', function(event) {
  const file = event.target.files[0];
  if (file) {
    const reader = new FileReader();
    reader.onload = function(e) {
      editor.value = e.target.result;
      currentFileName = file.name;
      setFileType(currentFileName);
      recordHistory(editor.value);
      renderEditor(editor.value);
      updateStatusDisplay(`File ${currentFileName} loaded.`, 'success');
    };
    reader.readAsText(file);
  }
});

// AI Request Trigger
$('#run-local-ai, #send-button').on('click', runAICodeRequest);

$('#prompt-input').on('keydown', function(event) {
  if (event.ctrlKey && event.key === 'Enter') {
    runAICodeRequest();
    event.preventDefault();
  }
});

// Initial setup on document ready
$(document).ready(function() {
  // Initial check to assume connection if API key is present
  setAIStatus(true, 'Nemodian Online');
  
  // Load initial code, record history, and render
  recordHistory(editor.value);
  renderEditor(editor.value);
  
  console.log("Nemodian 2244-1 Editor Initialized. AI ready for prompts.");
});
</script>
</body>
</html>

