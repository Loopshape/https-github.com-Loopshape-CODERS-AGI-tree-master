<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Nemodian Control Dashboard v2</title>
<style>
  body {
    background-color: #0a0a0c;
    color: #00ffc8;
    font-family: monospace;
    margin: 0;
    display: flex;
    height: 100vh;
    overflow: hidden;
  }
  #console {
    width: 68%;
    background: #101014;
    color: #00ffcc;
    padding: 12px;
    overflow-y: auto;
    border-right: 1px solid #202020;
    line-height: 1.3;
  }
  #panel {
    width: 32%;
    background: #141418;
    display: flex;
    flex-direction: column;
    justify-content: space-between;
  }
  h2 {
    color: #00e0ff;
    margin: 12px;
  }
  .btn {
    margin: 6px 12px;
    padding: 10px;
    background: #18181c;
    border: 1px solid #303030;
    border-radius: 8px;
    color: #00e0ff;
    cursor: pointer;
  }
  .btn:hover {
    background: #00e0ff33;
  }
  #cmdInput {
    width: calc(100% - 24px);
    margin: 10px;
    padding: 8px;
    background: #0d0d0f;
    border: 1px solid #303030;
    color: #00ffcc;
    border-radius: 6px;
  }
  #status {
    padding: 10px;
    background: #111;
    border-top: 1px solid #222;
    font-size: 0.9em;
    color: #888;
  }
</style>
</head>
<body>
  <div id="console"></div>
  <div id="panel">
    <div>
      <h2>Nemodian AES Dashboard</h2>
      <button class="btn" onclick="runCommand('pm2 restart nemodian-backup')">üîÅ Restart Backup</button>
      <button class="btn" onclick="runCommand('pm2 list')">üìã Show PM2 List</button>
      <button class="btn" onclick="runCommand('ai run . \"scan *\"')">üîç AI Scan</button>
      <button class="btn" onclick="fetchAuralLogs()">üåÄ Fetch Aural Logs</button>
      <input id="cmdInput" placeholder="Type custom command & hit Enter..." />
    </div>
    <div id="status">AES Status: üîí Locked</div>
  </div>

<script type="module">
import CryptoJS from "https://cdn.jsdelivr.net/npm/crypto-js@4.1.1/+esm";

const consoleEl = document.getElementById("console");
const statusEl = document.getElementById("status");
const cmdInput = document.getElementById("cmdInput");
let aesKey = null;
const bridge = "http://localhost:8080/ai";

appendToConsole("Nemodian AES Dashboard v2 initialized.");
appendToConsole("üîê Waiting for AES key... Type: aes:<yourpass>");

cmdInput.addEventListener("keydown", (e) => {
  if (e.key === "Enter") {
    const val = cmdInput.value.trim();
    if (val.startsWith("aes:")) {
      aesKey = val.split(":")[1];
      appendToConsole("üîë AES Key loaded.");
      statusEl.textContent = "AES Status: ‚úÖ Active";
      cmdInput.value = "";
    } else if (aesKey) {
      runCommand(val);
      cmdInput.value = "";
    } else {
      appendToConsole("‚ö†Ô∏è Please set AES key first: aes:<passphrase>");
    }
  }
});

async function runCommand(cmd) {
  if (!cmd) return;
  appendToConsole("> " + cmd);
  statusEl.textContent = "Running: " + cmd;

  try {
    const encrypted = CryptoJS.AES.encrypt(JSON.stringify({ prompt: cmd }), aesKey).toString();
    const res = await fetch(bridge, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ data: encrypted }),
    });
    const raw = await res.text();
    const decrypted = CryptoJS.AES.decrypt(raw, aesKey).toString(CryptoJS.enc.Utf8);
    appendToConsole(decrypted || raw);
  } catch (err) {
    appendToConsole("‚ö†Ô∏è AES/Fetch Error: " + err.message);
  }

  statusEl.textContent = "Idle";
}

function appendToConsole(text) {
  const lines = text.split("\n");
  for (const line of lines) {
    const div = document.createElement("div");
    div.textContent = line;
    consoleEl.appendChild(div);
  }
  consoleEl.scrollTop = consoleEl.scrollHeight;
}

async function fetchAuralLogs() {
  const date = new Date().toISOString().split("T")[0];
  appendToConsole(`\n--- [AURAL-LOGS ${date}] ---\n`);
  runCommand("pm2 logs --lines 200 --nostream");
}

// auto run every 24h
setInterval(fetchAuralLogs, 24 * 60 * 60 * 1000);

</script>
</body>
</html>
