<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>NEXUS | AI Editor (Safe Workflow)</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>

<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
:root{
  --primary:#BB86FC; --secondary:#03DAC6; --danger:#CF6679;
  --bg:#121212; --surface:#1E1E1E; --text:#FFFFFF; --muted:rgba(255,255,255,.7)
}
*{box-sizing:border-box}
body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;background:var(--bg);color:var(--text);margin:0;overflow:hidden;height:100vh}
#three-canvas{position:fixed;inset:0;z-index:10}
#ui-container{position:absolute;inset:0;z-index:20;padding:16px;display:grid;grid-template-columns:repeat(12,1fr);grid-template-rows:auto 1fr auto;gap:16px;pointer-events:none}
.agent-card{pointer-events:auto;background:rgba(30,30,30,.8);backdrop-filter:blur(8px);border-radius:12px;padding:12px;border:1px solid rgba(255,255,255,.06);box-shadow:0 6px 18px rgba(0,0,0,.5)}
.agent-card.active{border-color:var(--primary);box-shadow:0 0 30px rgba(187,134,252,.25)}
.agent-card.tunneling{border-color:var(--danger);box-shadow:0 0 30px rgba(207,102,121,.35)}
.agent-title{color:var(--primary);font-weight:700}
.agent-subtitle{color:var(--secondary);font-weight:300;font-size:.85rem}
.agent-hash{font-family:monospace;color:var(--secondary);opacity:.7;word-break:break-all}
.agent-content{margin-top:8px;color:var(--muted);font-size:.95rem;max-height:140px;overflow:auto}
#agent-nexus{grid-column:5/9;grid-row:1}
#agent-echo{grid-column:1/13;grid-row:2;display:flex;flex-direction:column;min-height:160px}
#agent-cognito{grid-column:1/5;grid-row:3}
#agent-relay{grid-column:5/9;grid-row:3}
#agent-sentinel{grid-column:9/13;grid-row:3}
#prompt-container{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;z-index:25;display:flex;gap:12px;width:min(92vw,920px);pointer-events:auto}
#prompt-input{flex:1;background:transparent;border:1px solid rgba(255,255,255,.06);padding:12px;border-radius:10px;color:var(--text);outline:none}
#prompt-submit{width:48px;height:48px;border-radius:12px;background:var(--secondary);border:none;color:var(--bg);cursor:pointer}
.spinner{border:4px solid rgba(255,255,255,.08);border-left-color:var(--secondary);border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
pre{background:#0b0b0b;color:var(--muted);padding:12px;border-radius:8px;overflow:auto;font-family:ui-monospace,monospace}
.data-packet{position:fixed;width:12px;height:12px;border-radius:50%;background:var(--primary);box-shadow:0 0 10px var(--primary);opacity:0}
.connection-good{color:#10B981}.connection-bad{color:#CF6679}
.copy-btn{background:transparent;border:1px solid rgba(255,255,255,.06);padding:6px;border-radius:6px;cursor:pointer}
.footer-note{font-size:.8rem;color:var(--muted);grid-column:1/-1;text-align:center;padding-top:8px}
</style>
</head>
<body>
<canvas id="three-canvas" aria-hidden="true"></canvas>

<div id="ui-container">
<div id="setup-card" class="agent-card" onclick="document.getElementById('setup-content').classList.toggle('open')">
<div class="flex justify-between items-center">
<h2 class="text-md font-bold" style="color:#FBBF24">► Ollama Connection Status</h2>
<div id="connection-status" class="text-sm font-semibold flex items-center gap-2 mr-4"><div class="spinner"></div><span>Connecting...</span></div>
</div>
<div id="setup-content" class="setup-content mt-4" style="max-height:0;overflow:hidden;transition:max-height .4s ease-out;color:var(--muted);font-size:.9rem">
<p>If status shows <span class="connection-bad" style="font-weight:700">Failed</span>, allow local origins and restart Ollama:</p>
<pre style="margin-top:8px"><code>export OLLAMA_ORIGINS='*' && ollama serve</code></pre>
</div>
</div>

<div id="agent-nexus" class="agent-card"><div class="agent-title">Nexus</div><div class="agent-subtitle">Model: core</div><div class="agent-hash">origin_hash: inactive</div><div class="agent-content">Idle.</div></div>
<div id="agent-echo" class="agent-card">
<div style="display:flex;justify-content:space-between;align-items:center">
<div>
<div class="agent-title">Echo</div>
<div class="agent-subtitle">Model: code</div>
<div class="agent-hash" id="echo-hash">origin_hash: inactive</div>
</div>
<div style="display:flex;gap:8px;align-items:center">
<button id="copy-code" class="copy-btn" title="Copy code">Copy</button>
<div id="copy-feedback" style="font-size:.85rem;color:var(--muted)"></div>
</div>
</div>
<div class="output-content" style="margin-top:8px;flex:1;display:flex;flex-direction:column">
<pre><code id="code-output" class="language-js">// Final AI generated code will appear here...</code></pre>
</div>
</div>
<div id="agent-cognito" class="agent-card"><div class="agent-title">Cognito</div><div class="agent-subtitle">Model: loop</div><div class="agent-hash">origin_hash: inactive</div><div class="agent-content">Idle.</div></div>
<div id="agent-relay" class="agent-card"><div class="agent-title">Relay</div><div class="agent-subtitle">Model: 2244</div><div class="agent-hash">origin_hash: inactive</div><div class="agent-content">Idle.</div></div>
<div id="agent-sentinel" class="agent-card"><div class="agent-title">Sentinel</div><div class="agent-subtitle">Model: coin</div><div class="agent-hash">origin_hash: inactive</div><div class="agent-content">Idle.</div></div>

<div class="footer-note">Quantum Tunneling Protocol · Local-only by default — safe workflow</div>
</div>

<div id="prompt-container">
<input id="prompt-input" placeholder="Initiate Cooperative Swarm..." aria-label="Prompt input">
<button id="prompt-submit" title="Send prompt">
<svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3l18 9-18 9V3z"/></svg>
</button>
</div>

<script type="module">
class StreamHighlighter {
  constructor(lang='js'){ this.lang=StreamHighlighter.langs[lang]||StreamHighlighter.langs.js; }
  static escape(s){ return s.replace(/[&<>]/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;'}[c])); }
  static langs = {
    js:{ rules:[
      {t:'comment',r:/^(\/\/[^\n]*|\/\*[\s\S]*?\*\/)/},
      {t:'string',r:/^`(?:\\[\s\S]|[^`])*`|^"(?:\\.|[^"])*"|^'(?:\\.|[^'])*'/},
      {t:'number',r:/^\b(?:0x[a-fA-F0-9]+|[0-9]+(?:\.[0-9]+)?(?:e[+-]?\d+)?)\b/},
      {t:'keyword',r:/^\b(?:if|else|for|while|function|return|const|let|var|class|new|in|of|switch|case|break|continue|try|catch|throw|async|await|import|from|export|default)\b/},
      {t:'bracket',r:/^[\[\]\{\}\(\)]/},{t:'op',r:/^==|===|!=|!==|<=|>=|=>|->|[-+*/%=<>!&|^~?:.,;]/},
      {t:'id',r:/^\b[a-zA-Z_$][\w$]*\b/},{t:'ws',r:/^\s+/}
    ] }
  };
  tokenize(txt){
    const o=[]; let i=0;
    while(i<txt.length){
      let m=null;
      for(const r of this.lang.rules){
        const s=txt.slice(i); const mm=r.r.exec(s);
        if(mm){ m={t:r.t,v:mm[0]}; break; }
      }
      if(!m){ o.push({t:'unknown',v:txt[i++]}); continue; }
      o.push(m); i+=m.v.length;
    }
    return o;
  }
  renderHTML(toks){ return toks.map(t=>`<span class="sh-token sh-${t.t}">${StreamHighlighter.escape(t.v)}</span>`).join(''); }
  highlightElement(el){
    const cL=[...el.classList].find(c=>c.startsWith('language-'));
    const l=cL?cL.replace('language-',''):'js';
    this.lang=StreamHighlighter.langs[l]||StreamHighlighter.langs.js;
    el.innerHTML=this.renderHTML(this.tokenize(el.textContent));
  }
}

class NexusSpaceship {
  constructor(){
    this.isGenerating=false;
    this.ollamaUrl='http://localhost:11434';
    this.dom={
      promptInput:document.getElementById('prompt-input'),
      promptSubmit:document.getElementById('prompt-submit'),
      codeOutput:document.getElementById('code-output'),
      connectionStatus:document.getElementById('connection-status'),
      copyBtn:document.getElementById('copy-code'),
      copyFeedback:document.getElementById('copy-feedback')
    };
    this.agentKeys=['nexus','cognito','relay','sentinel','echo'];
    this.analystKeys=['nexus','cognito','relay','sentinel'];
    this.agentConfig={
      nexus:{el:document.getElementById('agent-nexus'),model:'core',hashEl:document.querySelector('#agent-nexus .agent-hash'),content:document.querySelector('#agent-nexus .agent-content'),system:"As the Planning Agent with Origin Hash {ORIGIN_HASH} in a swarm for Genesis Hash {GENESIS_HASH}, create a high-level plan for the user's request: '{USER_PROMPT}'. The other agents are: {SWARM_MANIFEST}. Output only the plan."},
      cognito:{el:document.getElementById('agent-cognito'),model:'loop',hashEl:document.querySelector('#agent-cognito .agent-hash'),content:document.querySelector('#agent-cognito .agent-content'),system:"As the Logic Agent with Origin Hash {ORIGIN_HASH} in a swarm for Genesis Hash {GENESIS_HASH}, create a pseudo-code outline for the user's request: '{USER_PROMPT}'. The other agents are: {SWARM_MANIFEST}. Output only the logical outline."},
      relay:{el:document.getElementById('agent-relay'),model:'2244',hashEl:document.querySelector('#agent-relay .agent-hash'),content:document.querySelector('#agent-relay .agent-content'),system:"As the Details Agent with Origin Hash {ORIGIN_HASH} in a swarm for Genesis Hash {GENESIS_HASH}, suggest function/variable names for the user's request: '{USER_PROMPT}'. The other agents are: {SWARM_MANIFEST}. Output only your suggestions."},
      sentinel:{el:document.getElementById('agent-sentinel'),model:'coin',hashEl:document.querySelector('#agent-sentinel .agent-hash'),content:document.querySelector('#agent-sentinel .agent-content'),system:"As the Validation Agent with Origin Hash {ORIGIN_HASH} in a swarm for Genesis Hash {GENESIS_HASH}, identify edge cases and validation needs for the user's request: '{USER_PROMPT}'. The other agents are: {SWARM_MANIFEST}. Output only your validation points."},
      echo:{el:document.getElementById('agent-echo'),model:'code',hashEl:document.getElementById('echo-hash'),content:document.querySelector('#agent-echo .output-content'),
      initialSystem:"As the Schema Agent with Origin Hash {ORIGIN_HASH}, define the final answer shape for the user's request: '{USER_PROMPT}'. Output structural schema or code signature.",
      finalSystem:"As the Code Synthesis Agent, verify incoming analyses share the Genesis Hash. Then synthesize them into a single runnable code block. Output ONLY code."}
    };
    this.init();
  }

  init(){
    this.initEventListeners();
    this.checkConnection();
  }

  initEventListeners(){
    this.dom.promptSubmit.addEventListener('click', ()=>this.startWorkflow());
    this.dom.promptInput.addEventListener('keypress',(e)=>{if(e.key==='Enter') this.startWorkflow();});
    this.dom.copyBtn.addEventListener('click',()=>this.copyCode());
  }

  async checkConnection(){
    const candidates=[`${this.ollamaUrl}/api/ping`,`${this.ollamaUrl}/`,`${this.ollamaUrl}/api/models`];
    let ok=false;
    for(const url of candidates){
      try{ const r=await fetch(url,{method:'GET',mode:'cors'}); if(r.ok){ok=true;break;} }catch(e){}
    }
    this.dom.connectionStatus.innerHTML=ok?'<span class="connection-good">✅ Ollama Connected</span>':'<span class="connection-bad">❌ Connection Failed</span>';
  }

  updateAgentStatus(agentKey,status,message=''){
    const agent=this.agentConfig[agentKey];
    if(!agent||!agent.content) return;
    agent.el.classList.remove('active','tunneling');
    let contentHTML='';
    switch(status){
      case'processing':agent.el.classList.add('active');contentHTML=`<div style="display:flex;align-items:center;gap:8px"><div class="spinner"></div><span>${message}</span></div>`;break;
      case'complete':contentHTML=`<span style="color:#34D399">${message}</span>`;break;
      case'error':contentHTML=`<span style="color:#FB7185">${message}</span>`;break;
      case'tunneling':agent.el.classList.add('tunneling');contentHTML=`<div style="display:flex;align-items:center;gap:8px"><div class="spinner"></div><span style="color:#FB7185">${message}</span></div>`;break;
      default: contentHTML=message;
    }
    agent.content.innerHTML=contentHTML;
  }

  async callOllamaAgent(prompt,agentKey,systemPrompt){
    const agent=this.agentConfig[agentKey];
    this.updateAgentStatus(agentKey,'processing','Thinking...');
    const payload={model:agent.model,prompt,system:systemPrompt,stream:false};
    try{
      const response=await fetch(`${this.ollamaUrl}/api/generate`,{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
      if(!response.ok){let t=await response.text().catch(()=>null);throw new Error(`API error ${response.status} ${response.statusText}${t?': '+t:''}`);}
      const data=await response.json().catch(()=>null);
      const respText=(data&&(data.response||data.output||data.text))?(data.response||data.output||data.text):typeof data==='string'?data:JSON.stringify(data);
      this.updateAgentStatus(agentKey,'complete','Thinking Complete.');
      return String(respText||'');
    }catch(err){
      this.updateAgentStatus(agentKey,'error','Connection Error');throw err;
    }
  }

  async startWorkflow(){
    const initialPrompt=this.dom.promptInput.value.trim();
    if(!initialPrompt||this.isGenerating) return;
    this.isGenerating=true;this.dom.promptSubmit.disabled=true;
    this.agentKeys.forEach(k=>{const a=this.agentConfig[k];a.el.classList.remove('active','tunneling');if(a.content)a.content.innerHTML='...';});

    try{
      const genesisHash=`gen_${crypto.randomUUID()}`;
      const agentManifest={};
      this.agentKeys.forEach(key=>{const originHash=`${key.slice(0,4)}_${crypto.randomUUID().slice(0,8)}`;agentManifest[key]={originHash};this.agentConfig[key].hashEl.textContent=`origin_hash: ${originHash}`;});
      const swarmManifestString=JSON.stringify(Object.keys(agentManifest));

      const thinkingPromises=this.analystKeys.map(key=>{
        const sys=this.agentConfig[key].system?.replace?.('{ORIGIN_HASH}',agentManifest[key].[key].originHash)
          .replace('{GENESIS_HASH}', genesisHash)
          .replace('{USER_PROMPT}', initialPrompt)
          .replace('{SWARM_MANIFEST}', swarmManifestString);
        return this.callOllamaAgent(initialPrompt, key, sys)
          .then(res => ({key, output: res}))
          .catch(err => ({key, output: `Error: ${err.message}`})); 
      });

      // Wait for all analysts to finish
      const results = await Promise.all(thinkingPromises);

      // Display intermediate outputs safely
      results.forEach(r => {
        const agent = this.agentConfig[r.key];
        if(agent && agent.content) agent.content.innerText = r.output;
      });

      // Final Echo synthesis
      const combinedPrompt = results.map(r => `[${r.key}]: ${r.output}`).join('\n\n');
      const echoSystem = this.agentConfig.echo.finalSystem
        .replace('{ORIGIN_HASH}', agentManifest.echo.originHash)
        .replace('{GENESIS_HASH}', genesisHash)
        .replace('{USER_PROMPT}', initialPrompt)
        .replace('{SWARM_MANIFEST}', swarmManifestString);

      const finalCode = await this.callOllamaAgent(combinedPrompt, 'echo', echoSystem);
      this.dom.codeOutput.textContent = finalCode;
      new StreamHighlighter('js').highlightElement(this.dom.codeOutput);

    } catch(err){
      console.error('Workflow error:', err);
      alert('Workflow failed: ' + err.message);
    } finally {
      this.isGenerating=false;
      this.dom.promptSubmit.disabled=false;
    }
  }

  copyCode(){
    try{
      navigator.clipboard.writeText(this.dom.codeOutput.textContent);
      this.dom.copyFeedback.textContent='Copied!';
      setTimeout(()=>this.dom.copyFeedback.textContent='',1500);
    }catch(e){
      this.dom.copyFeedback.textContent='Copy Failed';
      setTimeout(()=>this.dom.copyFeedback.textContent='',1500);
    }
  }
}

const nexus = new NexusSpaceship();

// --- Three.js quantum background ---
const canvas = document.getElementById('three-canvas');
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight,0.1,1000);
const renderer = new THREE.WebGLRenderer({canvas,antialias:true,alpha:true});
renderer.setSize(window.innerWidth, window.innerHeight);
camera.position.z = 5;

const geometry = new THREE.TetrahedronGeometry(1,0);
const material = new THREE.MeshStandardMaterial({color:0xBB86FC,wireframe:true,opacity:0.15,transparent:true});
const mesh = new THREE.Mesh(geometry,material);
scene.add(mesh);

const light = new THREE.DirectionalLight(0xffffff,0.5);
light.position.set(5,5,5); scene.add(light);

function animate(){
  requestAnimationFrame(animate);
  mesh.rotation.x += 0.003; mesh.rotation.y += 0.005;
  renderer.render(scene, camera);
}
animate();

window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight;camera.updateProjectionMatrix();renderer.setSize(window.innerWidth,window.innerHeight);});
</script>
</body>
</html>
