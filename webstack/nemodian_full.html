<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Autonomous 5-Agent System | Material Simulation</title>
<!-- Load necessary external libraries -->
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.9.1/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-javascript.min.js"></script>

<style>
/* Base Styles & Material Dark Theme */
body{margin:0;background:#121212;color:#eee;font-family:'Inter',Roboto,sans-serif;height:100vh;overflow:hidden;}
#three-canvas{position:fixed;top:0;left:0;z-index:10;width:100%;height:100%;}
#ui-container{
    position:absolute;top:0;left:0;width:100%;height:100%;z-index:20;
    padding:16px;display:grid;
    /* 12-column grid */
    grid-template-columns:repeat(12, 1fr); 
    /* Three rows: auto height for top, 1fr for middle, auto for bottom */
    grid-template-rows: auto 1fr auto; 
    gap: 16px;
    pointer-events:none;
}
/* Material Card Styling (from base) */
.agent-card{
    background:#1F1F1F;
    border-radius:16px;
    padding:16px;
    color:#eee;
    box-shadow:0 4px 6px -1px rgba(0,0,0,0.4), 0 10px 15px -3px rgba(0,0,0,0.4);
    pointer-events:auto;
    transition: box-shadow 0.3s ease;
}

/* REBUILT: Grid Layout for 5-Agent Dashboard on 12-Column Grid */

/* Nexus: Top Row, Centered (Spans columns 5 to 9 - 4 columns wide) */
#agent-nexus { 
    grid-column: 5 / 9; 
    grid-row: 1 / 2; 
    height: fit-content;
} 

/* Echo: Middle Row, Full Width (Spans columns 1 to 13 - 12 columns wide) */
#agent-echo { 
    grid-column: 1 / 13; 
    grid-row: 2 / 3; 
    max-height: 100%; 
    overflow-y: auto; 
    z-index: 20; /* Ensures it sits over the full-height Echo panel from the previous iteration if it existed */
}

/* Cognito: Bottom Row, Left (Spans columns 1 to 5 - 4 columns wide) */
#agent-cognito { 
    grid-column: 1 / 5; 
    grid-row: 3 / 4; 
    height: fit-content;
} 
/* Relay: Bottom Row, Center (Spans columns 5 to 9 - 4 columns wide) */
#agent-relay { 
    grid-column: 5 / 9; 
    grid-row: 3 / 4; 
    height: fit-content;
} 
/* Sentinel: Bottom Row, Right (Spans columns 9 to 13 - 4 columns wide) */
#agent-sentinel { 
    grid-column: 9 / 13; 
    grid-row: 3 / 4; 
    height: fit-content;
} 


/* Material Typography & Color (from base) */
.agent-title{color:#BB86FC;font-weight:700;font-size:1.4em;}
.agent-subtitle{color:#03DAC6;font-weight:300;font-size:0.8em;margin-bottom:8px;}
.agent-content{
    margin-top:12px;
    font-size:0.9em;
    color:rgba(255,255,255,0.7);
    max-height: 100px; /* Kept for card content, but Echo is full-height */
    overflow-y: auto;
}
/* Input Prompt Styling (from base) */
#prompt-container{
    position:fixed;top:45%;left:50%;transform:translate(-50%,-50%);
    display:flex;gap:12px;z-index:25;
    width: min(90vw, 600px);
    background: #1F1F1F;
    border-radius: 12px;
    padding: 16px;
    box-shadow: 0 10px 20px rgba(0,0,0,0.6);
}
#prompt-input{
    flex-grow:1;
    background:transparent;
    border:none;
    border-bottom:2px solid rgba(187,134,252,0.5);
    color:#eee;
    font-size:1em;
    padding:8px;
    outline:none;
    transition: border-color 0.3s ease;
}
#prompt-input:focus{border-bottom-color:#BB86FC;}
#prompt-submit{
    width:48px;height:48px;
    border-radius:50%;
    background:#03DAC6;
    color: #121212;
    border:none;
    cursor:pointer;
    display:flex;align-items:center;justify-content:center;
    box-shadow: 0 4px 10px rgba(3,218,198,0.4);
    transition: transform 0.1s;
}
#prompt-submit:active{transform:scale(0.95);}

/* Data Packet Animation (from base) */
.data-packet{
    position:fixed;width:12px;height:12px;border-radius:50%;
    background:#BB86FC;
    box-shadow:0 0 10px #BB86FC;
    opacity:0;
    z-index:30;
}
.spinner{border:4px solid rgba(255,255,255,0.1);border-left-color:#03DAC6;border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}

/* PrismJS Code Highlighting Theme (from base) */
pre[class*="language-"] {
    margin: 0; padding: 10px; border-radius: 6px;
    background: #121212;
    font-size: 0.8em;
    white-space: pre-wrap;
    word-break: break-all;
    border: 1px solid #333;
}
.token.string { color: #81C784; }
.token.keyword { color: #BB86FC; }
.token.comment { color: #666666; }
</style>
</head>
<body>

<canvas id="three-canvas"></canvas>
<div id="prompt-container">
<input type="text" id="prompt-input" placeholder="Enter command or question..." autofocus>
<button id="prompt-submit">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="currentColor"><path d="M3 3l18 9-18 9V3z"/></svg>
</button>
</div>

<div id="ui-container">
<div id="agent-nexus" class="agent-card"><div class="agent-title">Nexus</div><div class="agent-subtitle">Orchestrator (Core)</div><div class="agent-content">Idle. Awaiting command.</div></div>
<div id="agent-cognito" class="agent-card"><div class="agent-title">Cognito</div><div class="agent-subtitle">Analyzer (Loop)</div><div class="agent-content">Offline</div></div>
<div id="agent-relay" class="agent-card"><div class="agent-title">Relay</div><div class="agent-subtitle">Communicator (2244)</div><div class="agent-content">Offline</div></div>
<div id="agent-sentinel" class="agent-card"><div class="agent-title">Sentinel</div><div class="agent-subtitle">Monitor (Coin)</div><div class="agent-content">Offline</div></div>
<div id="agent-echo" class="agent-card"><div class="agent-title">Echo</div><div class="agent-subtitle">Reporter (Code)</div><div class="agent-content">Awaiting final report...</div></div>
</div>

<!-- ENVIRONMENT VARIABLE INJECTION (Simulating .env read) -->
<script>
    /**
     * Simulated Dotfile / .env Injection
     * This block simulates a BUILD PROCESS reading a local .env file (e.g., via a utility 
     * like 'dotfiles-extension') and securely injecting client-visible environment variables
     * into the browser as global window properties.
     * In a hosted production environment, these must be replaced dynamically by a server.
     */

    (function() {
        // Example: API Key (must be replaced with actual key in .env or manually)
        window.__API_KEY_INJECTION__ = window.__API_KEY_INJECTION__ || null; 

        // Firebase / App Config
        window.__app_id = window.__app_id || 'simulation-app-123';
        window.__firebase_config = window.__firebase_config || JSON.stringify({
            apiKey: null,          // Replace with actual public Firebase API key if needed
            authDomain: null,
            projectId: null,
            storageBucket: null,
            messagingSenderId: null,
            appId: null
        });

        // Optional initial authentication token for pre-signed users
        window.__initial_auth_token = window.__initial_auth_token || null;

        // Additional environment variables (example: feature flags)
        window.__FEATURE_FLAGS__ = window.__FEATURE_FLAGS__ || {
            enableAdvancedTTS: true,
            enableDebugMode: false
        };

        console.log("[ENV INJECTION] Globals initialized:", {
            API_KEY: window.__API_KEY_INJECTION__,
            appId: window.__app_id,
            firebaseConfig: JSON.parse(window.__firebase_config),
            initialAuthToken: window.__initial_auth_token,
            featureFlags: window.__FEATURE_FLAGS__
        });
    })();
</script>

<script type="module">
// --- Firebase & Auth Setup (MANDATORY) ---
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

window.firebaseApp = null;
window.db = null;
window.auth = null;
window.userId = 'unauthenticated-user';

// Variables are now read from the injected global scope
const appId = typeof window.__app_id !== 'undefined' ? window.__app_id : 'default-app-id';
const firebaseConfig = typeof window.__firebase_config !== 'undefined' ? JSON.parse(window.__firebase_config) : null;
const initialAuthToken = typeof window.__initial_auth_token !== 'undefined' ? window.__initial_auth_token : null;

if (firebaseConfig && Object.keys(firebaseConfig).some(key => firebaseConfig[key] !== null)) { // Check if config has non-null values
    setLogLevel('Debug');
    window.firebaseApp = initializeApp(firebaseConfig);
    window.db = getFirestore(window.firebaseApp);
    window.auth = getAuth(window.firebaseApp);

    onAuthStateChanged(window.auth, async (user) => {
        if (user) window.userId = user.uid;
        else if (!user && initialAuthToken) {
            try { await signInWithCustomToken(window.auth, initialAuthToken); window.userId = window.auth.currentUser.uid; }
            catch { await signInAnonymously(window.auth); window.userId = window.auth.currentUser.uid; }
        } else { await signInAnonymously(window.auth); window.userId = window.auth.currentUser.uid; }
        console.log("Firebase Auth Ready. User ID:", window.userId);
    });
} else {
    // If no firebaseConfig is provided (like in the placeholder), log the unauthenticated state
    console.log("Firebase not configured. Running in unauthenticated mode.");
}

// --- Core Application Logic ---
// ðŸš¨ CRITICAL: The API key is read from the injected global variable (__API_KEY_INJECTION__)
const injectedApiKey = typeof window.__API_KEY_INJECTION__ !== 'undefined' && window.__API_KEY_INJECTION__ !== null 
    ? window.__API_KEY_INJECTION__ 
    : "YOUR_GEMINI_API_KEY_HERE";
    
const apiKey = injectedApiKey; 
const modelName = "gemini-2.5-flash-preview-09-2025";
const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

const crew = {
    nexus: { model:'core', el: document.getElementById('agent-nexus'), content: document.querySelector('#agent-nexus .agent-content') },
    cognito: { model:'loop', el: document.getElementById('agent-cognito'), content: document.querySelector('#agent-cognito .agent-content') },
    relay: { model:'2244', el: document.getElementById('agent-relay'), content: document.querySelector('#agent-relay .agent-content') },
    sentinel: { model:'coin', el: document.getElementById('agent-sentinel'), content: document.querySelector('#agent-sentinel .agent-content') },
    echo: { model:'code', el: document.getElementById('agent-echo'), content: document.querySelector('#agent-echo .agent-content') }
};

let isGenerating = false;
let isSpeaking = false;

// --- LLM Interaction Helpers ---

function isHumanPrompt(text){
    // Basic detection: ends with ? or contains interrogative
    return /\?$|^who|^what|^how|^when|^where|^why|^wer|^was|^wie|^wann|^wo|^warum/i.test(text.trim());
}

async function echoAnswer(promptText, answer){
    const isQuestion = isHumanPrompt(promptText);
    crew.echo.el.style.boxShadow = '0 0 20px #03DAC6';
    crew.echo.content.innerHTML = `<p class="text-sm">Response received from **Sentinel**. Compiling...</p>`;

    if(isQuestion){
        // 1. TTS only for questions
        crew.echo.content.innerHTML = `<p class="text-white text-sm text-left">Speaking answer (Model: ${crew.echo.model}).</p>`;
        // Note: generateTTSAndPlay is defined later in the script
        await generateTTSAndPlay(answer);
    } else {
        // 2. Code block for commands/code generation
        try {
            // Extract code block content if present - FIX: Completed regex
            const codeMatch = answer.match(/```(?:javascript|js)\n([\s\S]*?)\n```/i);

            const content = codeMatch ? codeMatch[1].trim() : answer.trim();

            const highlightedCode = Prism.highlight(content, Prism.languages.javascript, 'javascript');
            crew.echo.content.innerHTML = `<pre class="language-javascript"><code class="language-javascript">${highlightedCode}</code></pre>`;
        } catch(e) {
             crew.echo.content.innerHTML = `<p class="text-red-400">Error highlighting code. Raw output:</p><pre>${answer}</pre>`;
        }
    }

    // Return to standard elevation
    crew.echo.el.style.boxShadow = '0 4px 6px -1px rgba(0,0,0,0.4), 0 10px 15px -3px rgba(0,0,0,0.4)';
}

// --- Agent Workflow ---

async function startCrewSimulation(promptText) {
    if (isGenerating || isSpeaking) return;
    if (apiKey === "AIzaSyBtto2pvY2bTO26XwuV1hAB9RbSqYo3Fnw" || apiKey === null) {
         alert("Please replace 'YOUR_GEMINI_API_KEY_HERE' in the script or use the global variable injection (simulating .env read) to set your actual Gemini API Key to run the simulation.");
         return;
    }
    isGenerating = true;
    const submitBtn = document.getElementById('prompt-submit');
    submitBtn.disabled = true;

    // Clear previous output and set initial status
    Object.values(crew).forEach(a => {
        a.content.innerHTML = a.el.id === 'agent-nexus'
            ? `<div class="flex items-center space-x-2"><div class="spinner"></div><span>Processing input...</span></div>`
            : 'Idle.';
        a.el.style.boxShadow = '0 4px 6px -1px rgba(0,0,0,0.4), 0 10px 15px -3px rgba(0,0,0,0.4)';
    });
    crew.echo.content.innerHTML = `<p class="text-sm">Awaiting report...</p>`;

    const step = async (agentKey, statusMessage, duration = 800) => {
        const agent = crew[agentKey];
        agent.el.style.boxShadow = '0 0 20px #FFD54F'; // Highlight in Yellow
        agent.content.innerHTML = `<div class="flex items-center space-x-2"><div class="spinner"></div><span>${statusMessage}</span></div>`;
        await new Promise(r => setTimeout(r, duration));
        agent.el.style.boxShadow = '0 4px 6px -1px rgba(0,0,0,0.4), 0 10px 15px -3px rgba(0,0,0,0.4)';
    };

    try {
        // 1. PHASE: NEXUS (Data Packet Transfer)
        const inputRect = document.getElementById('prompt-container').getBoundingClientRect();
        const nexusRect = crew.nexus.el.getBoundingClientRect();
        animateDataPacket(inputRect, nexusRect, () => {
             // 2. PHASE: COGNITO (LLM Call)
            step('nexus', `Command received. Directing to ${crew.cognito.model}...`, 500).then(() => {
                const cognitoRect = crew.cognito.el.getBoundingClientRect();
                animateDataPacket(nexusRect, cognitoRect, async () => {
                    await step('cognito', `Executing Model Call...`, 1500);

                    const systemPrompt = isHumanPrompt(promptText)
                        ? "You are a concise, world-class AI system. Answer the user's question analytically and clearly. Use clear English."
                        : "You are a coding agent. Provide only a single, commented, runnable JavaScript code block that solves the user's request. Do not include any text outside the code block.";

                    const payload = {
                        contents: [{ parts: [{ text: promptText }] }],
                        tools: [{ "google_search": {} }],
                        systemInstruction: { parts: [{ text: systemPrompt }] }
                    };

                    let responseData = null, retryCount = 0, maxRetries = 3;
                    while (retryCount < maxRetries) {
                        try {
                            const response = await fetch(apiUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
                            if (!response.ok) {
                                if (response.status === 429 && retryCount < maxRetries - 1) {
                                    await new Promise(r => setTimeout(r, (Math.pow(2, retryCount) * 1000 + Math.random() * 1000))); retryCount++; continue;
                                } else { throw new Error(`API error: ${response.status}`); }
                            }
                            responseData = await response.json();
                            break;
                        } catch (e) { throw new Error(`API Failure in Cognito: ${e.message}`); }
                    }

                    const generatedText = responseData?.candidates?.[0]?.content?.parts?.[0]?.text || "Error: No response text found.";
                    crew.cognito.content.innerHTML = `<p class="text-sm">Processed. Routing to **Relay**.</p>`;

                    // 3. PHASE: RELAY & SENTINEL (Validation & Routing)
                    const cognitoRectUpdated = crew.cognito.el.getBoundingClientRect();
                    const echoRect = crew.echo.el.getBoundingClientRect();
                    animateDataPacket(cognitoRectUpdated, echoRect, async () => {
                        await step('relay', `Transmitting data... (Model: ${crew.relay.model})`, 1000);
                        await step('sentinel', `Validating integrity... (Model: ${crew.sentinel.model})`, 1000);

                        // 4. PHASE: ECHO (Final Report)
                        await step('echo', `Generating final report (Model: ${crew.echo.model})...`, 500);
                        await echoAnswer(promptText, generatedText);

                        // Final state
                        crew.nexus.content.innerHTML = 'Idle. Awaiting command.';
                        crew.cognito.content.innerHTML = 'Ready.';
                        crew.relay.content.innerHTML = 'Ready.';
                        crew.sentinel.content.innerHTML = 'Ready.';

                        // Persistence (optional)
                        if (window.db && window.userId !== 'unauthenticated-user') {
                            const docRef = doc(window.db, `artifacts/${appId}/users/${window.userId}/agent_reports`, `report_${Date.now()}`);
                            await setDoc(docRef, { prompt: promptText, response: generatedText.substring(0, 100) + '...', timestamp: new Date().toISOString() });
                        }
                        isGenerating = false;
                        submitBtn.disabled = false;
                    });
                });
            });

        });

    } catch (e) {
        console.error("Simulation failed:", e);
        Object.values(crew).forEach(a => a.el.style.boxShadow = '0 0 20px #ff0000');
        crew.echo.content.innerHTML = `<p class="text-red-400 font-bold">CRITICAL ERROR: ${e.message}</p>`;
        isGenerating = false;
        submitBtn.disabled = false;
    }
}

// --- GSAP Data Packet Animation (from base) ---
function animateDataPacket(sourceRect, targetRect, onComplete) {
    const packet = document.createElement('div');
    packet.className = 'data-packet';
    document.body.appendChild(packet);

    const startX = sourceRect.left + sourceRect.width / 2;
    const startY = sourceRect.top + sourceRect.height / 2;

    const endX = targetRect.left + targetRect.width / 2;
    const endY = targetRect.top + targetRect.height / 2;

    gsap.set(packet, { x: startX, y: startY, opacity: 1, scale: 0.5 });

    gsap.to(packet, {
        x: endX,
        y: endY,
        scale: 1.5,
        opacity: 0.8,
        duration: 0.8,
        ease: "power2.inOut",
        onComplete: () => {
            packet.remove();
            onComplete && onComplete();
        }
    });
}

// --- Three.js Plasma Background Setup ---
let scene, camera, renderer, uniforms, mesh;
let width = window.innerWidth, height = window.innerHeight;

const vertexShader = `void main(){gl_Position=vec4(position,1.0);}`;
const fragmentShader = `
uniform float time;
uniform vec2 resolution;
float plasma(vec2 p){return sin(p.x*10.0+time)+sin(p.y*10.0+time/2.0)+sin((p.x+p.y)*10.0+time/3.0)+sin(length(p)*10.0+time/4.0);}
void main(){
    vec2 uv=gl_FragCoord.xy/resolution.xy;
    uv=2.0*uv-1.0;
    float p=plasma(uv*0.5);
    vec3 color=0.5+0.5*cos(3.14159*(uv.xyx+vec3(0.0,0.6,0.9)+p*0.2));
    // Dark Material inspired color palette
    color*=vec3(0.1,0.1,0.3)+p*0.15;
    gl_FragColor=vec4(color,1.0);
}`;

function initThree() {
    scene = new THREE.Scene();
    camera = new THREE.Camera();
    camera.position.z = 1;
    renderer = new THREE.WebGLRenderer({ canvas: document.getElementById('three-canvas') });
    renderer.setSize(width, height);

    uniforms = { time: { type: 'f', value: 1.0 }, resolution: { type: 'v2', value: new THREE.Vector2(width, height) } };
    const material = new THREE.ShaderMaterial({ uniforms: uniforms, vertexShader: vertexShader, fragmentShader: fragmentShader });
    const geometry = new THREE.PlaneGeometry(2, 2);
    mesh = new THREE.Mesh(geometry, material);
    scene.add(mesh);

    window.addEventListener('resize', onWindowResize);
    onWindowResize();
    animateThree();
}

function onWindowResize() {
    width = window.innerWidth; height = window.innerHeight;
    renderer.setSize(width, height);
    uniforms.resolution.value.x = width;
    uniforms.resolution.value.y = height;
}

function animateThree() {
    requestAnimationFrame(animateThree);
    uniforms.time.value += 0.05;
    renderer.render(scene, camera);
}


// --- Audio TTS Utility Functions ---

function base64ToArrayBuffer(base64) {
    const binaryString = atob(base64);
    const len = binaryString.length;
    const bytes = new Uint8Array(len);
    for (let i = 0; i < len; i++) {
        bytes[i] = binaryString.charCodeAt(i);
    }
    return bytes.buffer;
}

function pcmToWav(pcm16, sampleRate = 24000) {
    const numChannels = 1;
    const bitsPerSample = 16;
    const byteRate = sampleRate * numChannels * (bitsPerSample / 8);
    const blockAlign = numChannels * (bitsPerSample / 8);
    const dataSize = pcm16.byteLength;
    const buffer = new ArrayBuffer(44 + dataSize);
    const view = new DataView(buffer);

    function writeString(view, offset, string) {
        for (let i = 0; i < string.length; i++) {
            view.setUint8(offset + i, string.charCodeAt(i));
        }
    }
    writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + dataSize, true); writeString(view, 8, 'WAVE');
    writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, 1, true);
    view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true);
    view.setUint32(28, byteRate, true); view.setUint16(32, blockAlign, true); view.setUint16(34, bitsPerSample, true);
    writeString(view, 36, 'data'); view.setUint32(40, dataSize, true);

    let offset = 44;
    for (let i = 0; i < pcm16.length; i++) { view.setInt16(offset, pcm16[i], true); offset += 2; }
    return new Blob([buffer], { type: 'audio/wav' });
}

function playAudioBuffer(wavBlob) {
    if (isSpeaking) return;
    const audioUrl = URL.createObjectURL(wavBlob);
    const audio = new Audio(audioUrl);

    audio.onplay = () => { isSpeaking = true; crew.echo.el.style.boxShadow = '0 0 20px #03DAC6'; };
    audio.onended = () => {
        isSpeaking = false;
        crew.echo.el.style.boxShadow = '0 4px 6px -1px rgba(0,0,0,0.4), 0 10px 15px -3px rgba(0,0,0,0.4)';
        URL.revokeObjectURL(audioUrl);
    };
    audio.play();
}

async function generateTTSAndPlay(textToSpeak) {
    if (isSpeaking) return;
    crew.echo.content.innerHTML = `<div class="flex items-center space-x-2"><div class="spinner"></div><span>Generating speech...</span></div>`;

    const ttsModelUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${apiKey}`;
    const payload = {
        contents: [{ parts: [{ text: textToSpeak }] }],
        generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } },
    };

    let responseData = null, retryCount = 0, maxRetries = 3;
    while (retryCount < maxRetries) {
        try {
            const response = await fetch(ttsModelUrl, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify(payload) });
            if (!response.ok) {
                if (response.status === 429 && retryCount < maxRetries - 1) { await new Promise(r => setTimeout(r, (Math.pow(2, retryCount) * 1000 + Math.random() * 1000))); retryCount++; continue; } else { throw new Error(`TTS API error: ${response.status}`); }
            }
            responseData = await response.json();
            break;
        } catch (e) {
            console.error("TTS generation failed:", e);
            crew.echo.content.innerHTML = `<span class="text-red-500">TTS Error: Cannot reach service.</span>`;
            return;
        }
    }

    const part = responseData?.candidates?.[0]?.content?.parts?.[0];
    const audioData = part?.inlineData?.data;
    const mimeType = part?.inlineData?.mimeType;

    if (audioData && mimeType && mimeType.startsWith("audio/L16")) {
        const rateMatch = mimeType.match(/rate=(\d+)/);
        const sampleRate = rateMatch ? parseInt(rateMatch[1], 10) : 24000;
        const pcmDataBuffer = base64ToArrayBuffer(audioData);
        const pcm16 = new Int16Array(pcmDataBuffer);
        const wavBlob = pcmToWav(pcm16, sampleRate);
        crew.echo.content.innerHTML = `<p class="text-green-400">Speaking...</p>`;
        playAudioBuffer(wavBlob);
    } else {
        console.error("No valid audio data returned from TTS API.");
        crew.echo.content.innerHTML = `<span class="text-red-500">TTS Error: Audio data missing.</span>`;
    }
}


// --- Event Listeners and Initialization ---

window.addEventListener('load', () => {
    initThree(); // Start the 3D background
    const promptInput = document.getElementById('prompt-input');
    const promptSubmit = document.getElementById('prompt-submit');

    // Initial state for non-Nexus agents
    crew.cognito.content.innerHTML = 'Ready.';
    crew.relay.content.innerHTML = 'Ready.';
    crew.sentinel.content.innerHTML = 'Ready.';
    crew.echo.content.innerHTML = 'Ready. Enter a command (like "write a javascript function to sort an array") or a question to begin.';

    const handleSubmit = () => {
        const promptText = promptInput.value.trim();
        if (promptText && !isGenerating && !isSpeaking) {
            startCrewSimulation(promptText);
            promptInput.value = ''; // Clear input after submission
        }
    };

    promptSubmit.addEventListener('click', handleSubmit);
    promptInput.addEventListener('keypress', (e) => {
        if (e.key === 'Enter') {
            handleSubmit();
        }
    });

    console.log("Autonomous 5-Agent System Initialized.");
});
</script>

</body>
</html>
