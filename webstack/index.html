<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nemodian 2244-1 :: Singlefile Offline AI Editor</title>
    <style>
        /* ----- Embedded Tailwind / UI Styles ----- */
        :root {
            --muted: #888;
            --info: #2196F3;
            --warn: #FF9800;
            --error: #F44336;
            --success: #4CAF50;
            --baseline: 1.5em;
            --header-h: calc(var(--baseline) * 1.6);
            --status-h: var(--baseline);
            --footer-h: calc(var(--baseline) * 2);
            --font-size: 13px; /* Adjusted default font size slightly for better legibility after removing zoom */
            --ln-width: 50px;
            --theme-bg: #3a3c31;
            --panel: #313328;
            --header-bg: #2e3026;
            --status-bg: #22241e;
            --accent: #4ac94a;
            --muted-text: #999966;
            --err: #a03333;
            --warn-bg: #f0ad4e;
            --hover-blue: #3366a0;
            --info-bg: #5bc0de;
        }

        /* ----- Base ----- */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Fira Code', monospace;
            font-size: var(--font-size);
            line-height: var(--baseline);
            background: var(--theme-bg);
            color: #f0f0e0;
            overflow: hidden;
        }

        body {
            display: grid;
            grid-template-rows: var(--header-h) var(--status-h) 1fr var(--footer-h);
            /* Removed: zoom: 0.5; - This is non-standard and causes layout issues. Adjust --font-size if overall smaller UI is desired. */
        }

        /* ----- Header ----- */
        header {
            grid-row: 1;
            grid-column: 1 / -1;
            background: var(--header-bg);
            border-bottom: 1px solid #22241e;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
        }

        header .left {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        header .right {
            display: flex;
            gap: 8px;
            align-items: center;
        }

        button {
            background: var(--err); /* Default button color, consider making it more neutral or specific */
            border: 1px solid var(--err);
            color: #f0f0e0;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all .2s;
            border-radius: 3px;
        }

        button:hover {
            background: var(--hover-blue);
            border-color: var(--hover-blue);
        }

        button.success {
            background: var(--accent);
            border-color: var(--accent);
        }

        button.info {
            background: var(--info-bg);
            border-color: var(--info-bg);
        }

        button.warn {
            background: var(--warn-bg);
            border-color: var(--warn-bg);
            color: #3a3c31; /* Adjust text color for better contrast on warn */
        }

        /* ----- Status Bar ----- */
        #status-bar {
            grid-row: 2;
            grid-column: 1 / -1;
            background: var(--status-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 12px;
            font-size: 12px;
        }

        #status-bar.error {
            background: var(--err);
            color: #f0f0e0;
        }

        #status-bar.warn {
            background: var(--warn-bg);
            color: #3a3c31;
        }

        #status-bar.success {
            background: var(--accent);
            color: #3a3c31;
        }

        #status-bar.info {
            background: var(--info-bg);
            color: #3a3c31;
        }

        /* ----- Editor Stage ----- */
        #editor-stage {
            grid-row: 3;
            grid-column: 1 / -1;
            display: grid;
            grid-template-columns: 240px 1fr; /* Default: left panel open */
            background: var(--theme-bg);
            overflow: hidden;
            position: relative;
            transition: grid-template-columns 0.3s ease; /* Smooth transition for panel toggle */
        }
        #editor-stage.left-panel-closed { /* Class for when left panel is closed */
            grid-template-columns: 0px 1fr;
        }


        #left-panel {
            /* width: 240px; This fixed width is redundant with grid-template-columns. */
            background: var(--panel);
            border-right: 1px solid #22241e;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* Removed transform, replaced by grid-template-columns change for better layout flow */
            /* transition: transform 0.3s ease; */
            /* transform: translateX(0); */
        }

        #left-panel.closed {
            /* transform: translateX(-100%); Not needed if grid-template-columns changes */
            /* The transition for width or grid-column-width needs to be on the parent grid container */
        }

        #editor-outer {
            position: relative;
            overflow: auto; /* This is the single scroll container */
            background: var(--theme-bg);
            display: flex;
            flex-grow: 1; /* Ensure it takes available space */
        }

        #line-gutter {
            width: var(--ln-width);
            padding: 10px 8px;
            box-sizing: border-box;
            background: var(--panel);
            color: var(--muted-text);
            font-variant-numeric: tabular-nums;
            text-align: right;
            user-select: none;
            line-height: var(--baseline);
            font-family: inherit;
            font-size: inherit;
            flex-shrink: 0;
        }

        .editor-content-wrapper {
            position: relative;
            flex-grow: 1;
        }

        .highlighting {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            pointer-events: none;
            /* overflow: hidden; Removed, as editor-outer is the main scroll. */
            padding: 10px;
            padding-left: 12px; /* Ensure same padding as editor for alignment */
            box-sizing: border-box;
            white-space: pre; /* Matches textarea */
            line-height: var(--baseline); /* Matches textarea */
            z-index: 10; /* Below textarea, above background */
        }

        .highlighting pre, .highlighting code {
            margin: 0;
            padding: 0 !important;
            background: none !important;
            font-family: inherit !important;
            font-size: inherit !important;
            line-height: inherit !important; /* Ensure line-height matches */
            white-space: pre !important;
            word-wrap: normal !important; /* Prevent word wrapping */
            word-break: normal !important; /* Prevent word breaking */
        }


        #editor {
            position: absolute;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            padding: 10px;
            margin: 0;
            box-sizing: border-box;
            overflow: hidden; /* Important: this textarea itself doesn't scroll, the parent #editor-outer does */
            background: transparent;
            color: transparent;
            caret-color: var(--accent);
            font-family: inherit;
            font-size: inherit;
            line-height: var(--baseline);
            border: 0;
            outline: 0;
            resize: none;
            white-space: pre; /* Important for code editing, prevents wrapping */
            z-index: 20;
            padding-left: 12px; /* Ensure same padding as highlighting for alignment */
        }


        /* ----- Footer ----- */
        footer {
            grid-row: 4;
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            background: var(--header-bg);
            border-top: 1px solid #22241e;
        }

        #prompt-input {
            flex: 1;
            margin-right: 8px;
            padding: 8px;
            background: var(--status-bg);
            border: 1px solid var(--accent);
            color: #f0f0e0;
            font-family: inherit;
            border-radius: 3px;
        }

        .small {
            font-size: 12px;
            padding: 6px 8px;
        }

        /* ----- Other Panels (Preview, AI, etc.) ----- */
        #preview-panel{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:80%;height:80%;background:white;border:2px solid var(--accent);border-radius:5px;z-index:1000;display:none;flex-direction:column;box-shadow:0 0 30px rgba(0,0,0,.7)}#preview-header{background:var(--header-bg);color:#f0f0e0;padding:8px 12px;display:flex;justify-content:space-between;align-items:center;border-bottom:1px solid var(--accent)}#preview-content{width:100%;height:calc(100% - 40px);border:none;background:white}#close-preview{background:transparent;border:none;color:#f0f0e0;font-size:18px;cursor:pointer;padding:0;width:24px;height:24px;display:flex;align-items:center;justify-content:center}#ai-response-panel{position:fixed;bottom:60px;right:20px;width:400px;max-height:300px;background:var(--panel);border:1px solid var(--accent);border-radius:5px;padding:10px;overflow-y:auto;z-index:100;display:none;box-shadow:0 4px 12px rgba(0,0,0,.3)}#ai-response-content{font-size:12px;line-height:1.4}#close-ai-panel{position:absolute;top:5px;right:5px;background:transparent;border:none;color:var(--muted-text);font-size:14px;cursor:pointer}#file-input{display:none}.ai-status{display:flex;align-items:center;gap:5px}.ai-dot{width:8px;height:8px;border-radius:50%;background:var(--accent); /* Default to connected/ready */ animation:none; /* No initial pulse */} .ai-dot.probing{background:var(--err); animation:pulse 2s infinite}.ai-dot.connected{background:var(--accent);animation:none}@keyframes pulse{0%{opacity:1}50%{opacity:.5}100%{opacity:1}}@media (max-width:768px){#editor-stage{grid-template-columns:1fr !important; /* Override inline style for mobile */} #left-panel{position:absolute;height:100%;z-index:30;transform:translateX(-240px); /* Keep transform for mobile overlay */} #left-panel.open{transform:translateX(0)}#ai-response-panel{width:calc(100% - 40px);right:20px;left:20px}#preview-panel{width:95%;height:85%}}
    </style>

    <!-- === [FIX] 1. EMBEDDED PRISM SYNTAX HIGHLIGHTING THEME === -->
    <!-- The theme itself was fine, just added proper structure. -->
    <style id="prism-theme">
        code[class*="language-"],pre[class*="language-"]{color:#ccc;background:0 0;font-family:Consolas,Monaco,'Andale Mono','Ubuntu Mono',monospace;font-size:1em;text-align:left;white-space:pre;word-spacing:normal;word-break:normal;word-wrap:normal;line-height:1.5;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-hyphens:none;-moz-hyphens:none;-ms-hyphens:none;hyphens:none}pre[class*="language-"]{padding:1em;margin:.5em 0;overflow:auto}:not(pre)>code[class*="language-"],pre[class*="language-"]{background:#2d2d2d}.token.block-comment,.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#999}.token.punctuation{color:#ccc}.token.attr-name,.token.deleted,.token.namespace,.token.tag{color:#e2777a}.token.function-name{color:#6196cc}.token.boolean,.token.function,.token.number{color:#f08d49}.token.class-name,.token.constant,.token.property,.token.symbol{color:#f8c555}.token.atrule,.token.builtin,.token.important,.token.keyword,.token.selector{color:#cc99cd}.token.attr-value,.token.char,.token.regex,.token.string,.token.variable{color:#7ec699}.token.entity,.token.operator,.token.url{color:#67cdcc}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.token.inserted{color:green}
    </style>
</head>
<body>
<header>
    <div class="left">
        <button id="left-toggle" class="small">✕</button> <!-- Changed default to 'X' since panel starts open -->
        <div style="font-weight:800;">Nemodian 2244-1 :: AI Editor</div>
    </div>
    <div class="right">
        <div class="ai-status">
            <div id="ai-dot" class="ai-dot connected"></div> <!-- Default to connected -->
            <div id="ai-indicator" style="font-size:12px;color:#cfcfbd;">Local AI: Ready</div>
        </div>
        <button id="open-file" class="small">Open</button>
        <button id="save-file" class="small">Save</button>
        <button id="save-as" class="small">Save As</button>
        <button id="render-html" class="small warn">Render HTML</button>
        <button id="run-local-ai" class="small info">Run AI</button>
    </div>
</header>
<div id="status-bar" class="info">
    <div id="file-meta">No File Loaded</div>
    <div id="editor-meta">Cursor: 0:0 | Lines: 0 | Chars: 0 | History: 0</div>
</div>
<div id="editor-stage">
    <aside id="left-panel"> <!-- Removed 'closed' class, as panel starts open -->
        <button id="btn-undo" class="small">UNDO</button>
        <button id="btn-redo" class="small">REDO</button>
        <button id="btn-beautify" class="small">Beautify</button>
        <button id="btn-render" class="small warn">Render HTML</button>
        <div style="margin-top: 20px; font-size: 11px; color: var(--muted-text);">
            <p><strong>AI Commands:</strong></p>
            <ul style="padding-left: 15px;">
                <li>Explain this code</li>
                <li>Optimize this function</li>
                <li>Add comments</li>
                <li>Fix bugs</li>
            </ul>
        </div>
        <div style="margin-top: 20px; font-size: 11px; color: var(--muted-text);">
            <p><strong>HTML Render:</strong></p>
            <p>Click "Render HTML" to preview your HTML code in a live browser view.</p>
        </div>
    </aside>
    <div id="editor-outer">
        <div id="line-gutter"></div>
        <div class="editor-content-wrapper">
             <div class="highlighting">
                <pre><code id="highlighted" class="language-html"></code></pre>
            </div>
            <textarea id="editor" spellcheck="false">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
  &lt;title&gt;Nemodian 2244-1 Demo&lt;/title&gt;
  &lt;style&gt;
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      color: white;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: rgba(0, 0, 0, 0.7);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      max-width: 600px;
      text-align: center;
    }
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(90deg, #4ac94a, #5bc0de);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    p {
      font-size: 1.2rem;
      line-height: 1.6;
    }
    .features {
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 15px;
      margin: 20px 0;
    }
    .feature {
      background: rgba(74, 201, 74, 0.2);
      padding: 10px 15px;
      border-radius: 8px;
      border: 1px solid #4ac94a;
    }
    button {
      background: #4ac94a;
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 5px;
      font-size: 1rem;
      cursor: pointer;
      transition: all 0.3s;
    }
    button:hover {
      background: #3aa83a;
      transform: translateY(-2px);
    }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class="container"&gt;
    &lt;h1&gt;Welcome to Nemodian 2244-1&lt;/h1&gt;
    &lt;p&gt;This is a demonstration of the offline AI editor's capabilities. You can edit this HTML and CSS, and then click "Render HTML" to see your changes.&lt;/p&gt;
    &lt;div class="features"&gt;
      &lt;div class="feature"&gt;HTML Editing&lt;/div&gt;
      &lt;div class="feature"&gt;CSS Styling&lt;/div&gt;
      &lt;div class="feature"&gt;AI Assistance&lt;/div&gt;
    &lt;/div&gt;
    &lt;button&gt;Get Started&lt;/button&gt;
  &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</textarea>
        </div>
    </div>
</div>
<footer>
    <input id="prompt-input" placeholder="AI Prompt (Ctrl+Enter to run)">
    <button id="send-button" class="success">SEND</button>
</footer>
<input type="file" id="file-input" accept=".js,.html,.css,.txt,.json">
<div id="preview-panel">
    <div id="preview-header">
        <span>HTML Preview</span>
        <button id="close-preview">×</button>
    </div>
    <iframe id="preview-content"></iframe>
</div>
<div id="ai-response-panel">
    <button id="close-ai-panel">×</button>
    <div id="ai-response-content"></div>
</div>

<!-- === [FIX] 2. EMBEDDED PRISM.JS CORE AND LANGUAGES (Replaced with a standard minified build) === -->
<script>
/* PrismJS 1.29.0
https://prismjs.com/download.html#themes=prism-dark&languages=markup+css+clike+javascript+json */
var _self="undefined"!=typeof window?window:"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?self:{},Prism=function(u){var c=/\blang(?:uage)?-([\w-]+)\b/i,n=0,e={},M={manual:u.manual,disableWorkerMessageHandler:u.disableWorkerMessageHandler,util:{encode:function(e){if(e instanceof A)return new A(e.type,M.util.encode(e.content),e.alias);if(Array.isArray(e))return e.map(M.util.encode);return e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\u00a0/g," ")},type:function(e){return Object.prototype.toString.call(e).slice(8,-1)},objId:function(e){return e.__id||Object.defineProperty(e,"__id",{value:++n}),e.__id},clone:function t(e,r){var a,n,i=M.util.type(e);switch(r=r||{},i){case"Object":if(n=M.util.objId(e),r[n])return r[n];for(var o in a={},r[n]=a,e)e.hasOwnProperty(o)&&(a[o]=t(e[o],r));return a;case"Array":return n=M.util.objId(e),r[n]?r[n]:(a=[],r[n]=a,e.forEach(function(e,n){a[n]=t(e,r)}),a);default:return e}}},languages:{extend:function(e,n){var t=M.languages.clone(M.languages[e]);for(var r in n)t[r]=n[r];return t},insertBefore:function(t,e,n,r){var a=(r=r||M.languages)[t],i={};for(var o in a)if(a.hasOwnProperty(o)){if(o==e)for(var l in n)n.hasOwnProperty(l)&&(i[l]=n[l]);i[o]=a[o]}var s=r[t];return r[t]=i,M.languages.DFS(M.languages,function(e,n){n===s&&e!=t&&(this[e]=i)}),i},DFS:function e(n,t,r,a){a=a||{};var i=M.util.objId(n);if(!a[i]){a[i]=!0;for(var o in n)n.hasOwnProperty(o)&&(t.call(n,o,n[o],r||o),M.util.type(n[o])!=="Object"||a[M.util.objId(n[o])]||M.util.type(n[o])!=="Array"||a[M.util.objId(n[o])]||e(n[o],t,o,a))}}},plugins:{},highlightAll:function(e,n){M.highlightAllUnder(document,e,n)},highlightAllUnder:function(e,n,t){var r={callback:t,container:e,selector:'code[class*="language-"], [class*="language-"] code, code[class^="lang-"], [class^="lang-"] code'};M.hooks.run("before-highlightall",r),r.elements=Array.prototype.slice.apply(r.container.querySelectorAll(r.selector)),M.hooks.run("before-all-elements-highlight",r);for(var a,i=0;a=r.elements[i++];)M.highlightElement(a,n===!0,r.callback)},highlightElement:function(e,n,t){var r,a,i=M.util.getLanguage(e);r=M.languages[i];var o=e.parentNode;o&&"pre"===o.nodeName.toLowerCase()&&(i=M.util.getLanguage(o)),a=M.languages[i],e.textContent&&(i=e.textContent,o=e.innerHTML,e.innerHTML="",M.hooks.run("before-sanity-check",{element:e,language:i,code:i}),M.hooks.run("before-highlight",{element:e,language:i,grammar:a,code:i}),a?(n=M.highlight(i,a,i),M.hooks.run("before-insert",{element:e,highlightedCode:n}),e.innerHTML=n,M.hooks.run("after-highlight",{element:e,language:i,grammar:a,code:i,highlightedCode:n}),M.hooks.run("complete",{element:e,language:i,grammar:a,code:i,highlightedCode:n}),t&&t.call(e)):(M.hooks.run("complete",{element:e,language:i,code:i}),e.textContent=i))},highlight:function(e,n,t){var r={code:e,grammar:n,language:t};return M.hooks.run("before-tokenize",r),r.tokens=M.tokenize(r.code,r.grammar),M.hooks.run("after-tokenize",r),A.stringify(M.util.encode(r.tokens),r.language)},matchGrammar:function(e,n,t,r,a,i,o){for(var l in t)if(t.hasOwnProperty(l)&&t[l]){if(l==o)return;var s=t[l];s="Array"===M.util.type(s)?s:[s];for(var u=0;u<s.length;++u){if(i&&l===i[0]&&s[u]===i[1])return;var c=s[u],g={pattern:c,lookbehind:!1,greedy:!1,alias:null,inside:null};if(c instanceof RegExp){c=g;var p=e.exec(c.pattern);if(p&&(!i||!i[0]||!i[1]||i[0]!==l||i[1]!==c))break}if(p){a=M.util.clone(p);var h=p.index+(!c.lookbehind?0:p[1].length),d=p[0].length-(!c.lookbehind?0:p[1].length)-(!c.greedy&&p[p.length-1].length?p[p.length-1].length:0);if(c.greedy&&!p.index){var f=p[0].slice(1);if(!f.length){p=null;break}d+=f.length,h--}if(d>0){a.offset=h,a.length=d,a.value=p[0].slice(h,h+d),p[0]=p[0].slice(0,h)+p[0].slice(h+d),a.resettable=p.resettable,a.sticky=p.sticky,delete p.index,delete p.input,M.matchGrammar(e,n,t,r,a,i,o)}else if(p[0]=e[h-1],d<0){var m=p[0].slice(h,h+d);a.resettable=p.resettable,a.sticky=p.sticky,a.offset=h,a.length=d,a.value=m,a.inside=p.inside,p[0]=p[0].slice(0,h)+p[0].slice(h+d),delete p.index,delete p.input,M.matchGrammar(e,n,t,r,a,i,o)}else if(p[0].length){M.matchGrammar(e,n,t,r,null,i,o);break}}}}},tokenize:function(e,n){var t=[e],r=n.rest;if(r){for(var a in r)n[a]=r[a];delete n.rest}var i=new LinkedList,o=i.head,l=0;M.matchGrammar(e,i,n,o,0),function(e){var n=[],t=e.head.next;for(;t!==e.tail;)n.push(t.value),t=t.next;return n}(i)},hooks:{all:{},add:function(e,n){var t=M.hooks.all;t[e]=t[e]||[],t[e].push(n)},run:function(e,n){var t=M.hooks.all[e];if(t&&t.length)for(var r,a=0;r=t[a++];)r(n)}},Token:A};function A(e,n,t,r){this.type=e,this.content=n,this.alias=t,this.length=0|(r||"").length}function LinkedList(){var e={value:null,prev:null,next:null},n={value:null,prev:e,next:null};e.next=n,this.head=e,this.tail=n,this.length=0}function matchGrammar(e,n,t,r,a,i){t.lastIndex=a;var o=t.exec(e);if(o&&i&&o[1]){var l=o[1].length;o.index+=l,o[0]=o[0].slice(l)}if(o){i&&0<l&&(n.lastIndex=o.index+o[0].length);var s=n.last,u=s.length;if(!(o.index<n.lastIndex)){if(n.lastIndex=o.index+o[0].length,s.next=o,s=s.next,s.value=o[0],s.prev=n.last,s.next=n.tail,n.last=s,u<o.index)for(var c=e.slice(u,o.index),g=new LinkedList,p=g.head,h=0;h<c.length;h+=1)p.next=new A("text",c[h]),p.next.prev=p,p=p.next;g.head.next.prev=n.last.prev,n.last.prev.next=g.head.next,n.last.prev=g.tail,g.tail.next=n.last,n.last.prev.prev.next.value&&(n.last.prev=g.tail.prev);var d,f,m=o.slice(1),v=!!(m=m.filter(function(e){return e!==u})).length,y=m[0]||null;v&&null!==y?d=new A(t,y):g?d=new A(t,p.value):v||(d=new A(t,c)),s.value=d,f=g.head.next,M.matchGrammar(e,g,t,f,g.lastIndex,i)}}}return A.stringify=function n(e,t){if("string"==typeof e)return e;if(Array.isArray(e))return e.map(function(e){return n(e,t)}).join("");var r={type:e.type,content:n(e.content,t),tag:"span",classes:["token",e.type],attributes:{},language:t};if(e.alias){var a=Array.isArray(e.alias)?e.alias:[e.alias];Array.prototype.push.apply(r.classes,a)}M.hooks.run("wrap",r);var i=Object.keys(r.attributes).map(function(e){return e+'="'+(r.attributes[e]||"").replace(/"/g,"&quot;")+'"'}).join(" ");return"<"+r.tag+' class="'+r.classes.join(" ")+'"'+(i?" "+i:"")+">"+r.content+"</"+r.tag+">"},M.util.getLanguage=function(e){for(;e&&!c.test(e.className);)e=e.parentNode;return e?((e.className.match(c)||[,"none"])[1]||"none").toLowerCase():"none"},M.hooks.add("before-highlight",function(e){var n=e.element.parentNode;n&&/pre/i.test(n.nodeName)&&(n.className=n.className.replace(c,"")+" language-"+e.language)}),M.hooks.add("after-highlight",function(e){var n=e.element.parentNode;n&&/pre/i.test(n.nodeName)&&!n.hasAttribute("tabindex")&&n.setAttribute("tabindex","0")}),u.document?((e=u.document).readyState&&"loading"!==e.readyState&&"interactive"!==e.readyState||e.addEventListener("DOMContentLoaded",function(){M.highlightAll()}),M):u.addEventListener?u.addEventListener("message",function(e){var n=JSON.parse(e.data),t=n.language,r=n.code,a=n.immediateCallback;"undefined"!=typeof Prism&&u.postMessage(M.highlight(r,M.languages[t],t)),a&&u.postMessage(M.highlight(r,M.languages[t],t))},!1):M}(_self);
"undefined"!=typeof module&&module.exports&&(module.exports=Prism),"undefined"!=typeof global&&(global.Prism=Prism);
Prism.languages.clike={comment:[{pattern:/(^|[^\\])\/\*[\s\S]*?(?:\*\/|$)/,lookbehind:!0,greedy:!0},{pattern:/(^|[^\\:])\/\/.*/,lookbehind:!0,greedy:!0}],string:{pattern:/(["'])(?:\\(?:\r\n|[\s\S])|(?!\1)[^\\\r\n])*\1/,greedy:!0},'class-name':{pattern:/((?:\b(?:class|interface|extends|implements|trait|instanceof|new)\s+)|(?:catch\s+\())[\w.\\]+/i,lookbehind:!0,inside:{punctuation:/[.\\]/}},keyword:/\b(?:if|else|while|do|for|return|in|instanceof|function|new|try|throw|catch|finally|null|break|continue)\b/,boolean:/\b(?:true|false)\b/,function:/\w+(?=\()/,number:/\b0x[\da-f]+\b|(?:\b\d+\.?\d*|\B\.\d+)(?:e[+-]?\d+)?/i,operator:/--?|\+\+?|!=?=?|<=?|>=?|==?=?|&&?|\|\|?|\?|\*|\/|~|&|\||%|!|=[ \t]*=/,punctuation:/[\[\]{}().,;:]/};
Prism.languages.javascript=Prism.languages.extend("clike",{string:/"(?:(?:\\(?:\\r|\\n|.)?)|[^"\\\r\n])*"|'(?:(?:\\(?:\\r|\\n|.)?)|[^'\\\r\n])*'|`(?:(?:\\(?:\\r|\\n|.)?)|[^`])*`/,keyword:/\b(?:as|async|await|break|case|catch|class|const|continue|debugger|default|delete|do|else|enum|export|extends|finally|for|from|function|get|if|implements|import|in|instanceof|interface|let|new|null|of|package|private|protected|public|return|set|static|super|switch|this|throw|try|typeof|var|void|while|with|yield|false|true|undefined)\b/,number:/\b(?:(?:0[xX](?:[\dA-Fa-f](?:_?[\dA-Fa-f])*))|(?:0[oO](?:[0-7](?:_?[0-7])*))|(?:0[bB](?:[01](?:_?[01])*))|(?:\d(?:_?\d)*\.\d+(?:[eE][+-]?\d+)?)|(?:\.\d+(?:[eE][+-]?\d+)?)|(?:\d(?:_?\d)*(?:[eE][+-]?\d+)?)|(?:\d(?:_?\d)*))\b/,function:/[A-Z][\w]*(?=\s*\()/i,operator:/--|\+\+|!=?=?|<=?|>=?|==?=?|&&?|\|\|?|\?|\*\*?|\/|~|&|\||%|!|=>|\.{3}/,punctuation:/[{}[\];(),.:]/});Prism.languages.insertBefore("javascript","keyword",{"template-string":{pattern:/`([^`]|\\`)*`/,greedy:!0,inside:{string:/[\s\S]+/}}});
Prism.languages.markup={comment:/<!--[\s\S]*?-->/,prolog:/<\?[\s\S]+?\?>/,doctype:/<!DOCTYPE[^>]+>/i,cdata:/<!\[CDATA\[[\s\S]*?]]>/i,tag:{pattern:/<\/?(?!\d)[^\s>\/=$<%]+(?:\s(?:\s*[^\s>\/=]+(?:\s*=\s*(?:"[^"]*"|'[^']*'|[^\s'">=]+))?)+\s*|\s*)\/?>/i,greedy:!0,inside:{tag:{pattern:/^<\/?[^\s>\/]+/i,inside:{punctuation:/^<\/?/,namespace:/^[^\s>\/:]+:/}},"attr-value":{pattern:/=\s*(?:"[^"]*"|'[^']*'|[^\s'">=]+)/i,inside:{punctuation:[/^=/,{pattern:/^(\s*)["']|["']$/,lookbehind:!0}]}},punctuation:/\/?>/,"attr-name":{pattern:/[^\s>\/=]+/,inside:{namespace:/^[^\s>\/:]+:/}}}},entity:/&#?[\da-z]{1,8};/i};Prism.languages.markup.tag.inside["attr-value"].inside.entity=Prism.languages.markup.entity,Prism.hooks.add("wrap",function(a){"entity"===a.type&&(a.attributes.title=a.content.replace(/&amp;/,"&"))}),Object.defineProperty(Prism.languages.markup.tag,"addInlined",{value:function(a,e){var s={};s["language-"+e]={pattern:/(^<!\[CDATA\[)[\s\S]+?(?=\]\]>$)/i,lookbehind:!0,inside:Prism.languages[e]},s.cdata=/^<!\[CDATA\[|\]\]>$/i;var t={"included-cdata":{pattern:/<!\[CDATA\[[\s\S]*?\]\]>/i,inside:s}};t["script-descriptor"]={pattern:/^<\/script>/i,greedy:!0},Prism.languages.insertBefore("markup","cdata",t)}}),Prism.languages.html=Prism.languages.markup,Prism.languages.mathml=Prism.languages.markup,Prism.languages.svg=Prism.languages.markup;
Prism.languages.css={comment:/\/\*[\s\S]*?\*\//,atrule:{pattern:/@[\w-]+[\s\S]*?(?:;|(?=\s*\{))/i,inside:{rule:/@[\w-]+/}},url:/url\((?:(["'])(?:\\(?:\r\n|[\s\S])|(?!\1)[^\\\r\n])*\1|[^_)\s]+)\)/i,selector:/(?![^{{ }])[^{{ }][^{{ }}]*(?=\s*\{)/,string:{pattern:/(["'])(?:\\(?:\r\n|[\s\S])|(?!\1)[^\\\r\n])*\1/,greedy:!0},property:/[-_a-z\xA0-\uFFFF][-\w\xA0-\uFFFF]*(?=\s*:)/i,important:/\B!important\b/i,function:/[-a-z0-9]+(?=\()/i,punctuation:/[(){};:,]/};Prism.languages.css.atrule.inside.rest=Prism.languages.css,Prism.languages.markup&&Prism.languages.insertBefore("markup","tag",{style:{pattern:/(<style[\s\S]*?>)[\s\S]*?(?=<\/style>)/i,lookbehind:!0,inside:Prism.languages.css,alias:"language-css",greedy:!0}});
Prism.languages.json={property:/"(?:\\.|[^\\"\r\n])*"(?=\s*:)/i,string:/"(?:\\.|[^\\"\r\n])*"(?!\s*:)/,number:/\b-?(0x[\dA-Fa-f]+|\d*\.?\d+([Ee][+-]?\d+)?)\b/,punctuation:/[{}[\]);,:]/,operator:/:/,boolean:/\b(true|false)\b/,null:/\bnull\b/i};
</script>


<script>
    // These beautifier functions are currently stubs.
    // To enable actual beautification, you would need to embed a library
    // like js-beautify (https://github.com/beautify-web/js-beautify)
    // and replace these placeholders.
    function js_beautify(code) { console.warn("js_beautify stub called."); return code; }
    function css_beautify(code) { console.warn("css_beautify stub called."); return code; }
    function html_beautify(code) { console.warn("html_beautify stub called."); return code; }
</script>
<script>
    // This is defined but not used. It's benign, but could be removed if not needed.
    // window.$ = document.querySelectorAll.bind(document);
</script>
<script>
    // ----- Editor Logic -----
    const editor = document.getElementById('editor');
    const editorOuter = document.getElementById('editor-outer');
    const highlightedCode = document.getElementById('highlighted'); // Renamed to avoid confusion with `highlightAndRender` param
    const lineGutter = document.getElementById('line-gutter');
    const statusEditor = document.getElementById('editor-meta');
    const statusFile = document.getElementById('file-meta');
    const previewPanel = document.getElementById('preview-panel');
    const previewContent = document.getElementById('preview-content');
    const aiResponsePanel = document.getElementById('ai-response-panel');
    const aiResponseContent = document.getElementById('ai-response-content');
    const leftPanel = document.getElementById('left-panel');
    const editorStage = document.getElementById('editor-stage'); // Added for left panel toggle


    let currentFileName = null,
        currentFileType = 'html', // Default language for Prism
        historyStack = [],
        redoStack = [];

    function detectLanguage(fname) {
        const ext = fname?.split('.').pop().toLowerCase();
        return {
            'js': 'javascript',
            'html': 'html',
            'htm': 'html',
            'css': 'css',
            'json': 'json',
            'txt': 'clike' // General text files, or can be 'none'
        } [ext] || 'html'; // Default to html
    }

    // === [FIX] 3. UPDATED HIGHLIGHTING FUNCTION ===
    // Now highlights the `highlightedCode` element with the determined language class.
    function highlightAndRenderCode(code) {
        highlightedCode.textContent = code; // Place the raw code into the <code> element
        // Ensure the language class is set on the <code> element itself
        if (!highlightedCode.classList.contains('language-' + currentFileType)) {
            // Remove all language classes before adding the new one
            highlightedCode.className = '';
            highlightedCode.classList.add('language-' + currentFileType);
        }
        Prism.highlightElement(highlightedCode); // Trigger Prism to highlight it
    }

    function generateLineNumbers() {
        // Calculate max scroll height for gutter and editor
        const lineHeight = parseFloat(getComputedStyle(editor).lineHeight);
        const lineCount = editor.value.split('\n').length;
        const totalHeight = lineCount * lineHeight + parseFloat(getComputedStyle(editor).paddingTop) + parseFloat(getComputedStyle(editor).paddingBottom);

        // Update gutter content
        lineGutter.innerHTML = Array.from({length: lineCount}, (_, i) => i + 1).join('<br>');

        // Ensure editor-outer minimum scroll height covers content
        // This is a bit tricky with flexbox and absolute positioning,
        // but ensuring the inner content pushes the scroll of editor-outer is key.
        // For simplicity, we can sometimes directly set min-height on editor-content-wrapper
        // or ensure the last line is visible.
        // If content height exceeds editor-outer height, scrollbar will appear naturally.
    }

    function renderEditor(code) {
        editor.value = code;
        highlightAndRenderCode(code); // Call the fixed highlighting function
        generateLineNumbers();
        updateStatus();
    }

    function updateStatus() {
        const pos = editor.selectionStart;
        const lines = editor.value.substr(0, pos).split('\n');
        statusEditor.textContent = `Cursor: ${lines.length}:${lines[lines.length - 1].length} | Lines: ${editor.value.split('\n').length} | Chars: ${editor.value.length} | History: ${historyStack.length}`;
    }

    // === [FIX] Simplified syncScroll function ===
    // Only lineGutter needs its scrollTop adjusted as editor-outer is the primary scroll.
    function syncScroll() {
        lineGutter.scrollTop = editorOuter.scrollTop;
    }

    function pushHistory() {
        const code = editor.value;
        if (historyStack.length && historyStack[historyStack.length - 1] === code) return;
        historyStack.push(code);
        redoStack = [];
        updateStatus();
    }

    function undo() {
        if (historyStack.length > 1) { // Need at least two states to undo (current + previous)
            redoStack.push(historyStack.pop());
            renderEditor(historyStack[historyStack.length - 1]);
        }
    }

    function redo() {
        if (redoStack.length) {
            const nextState = redoStack.pop();
            historyStack.push(nextState);
            renderEditor(nextState);
        }
    }

    editor.addEventListener('input', () => {
        pushHistory();
        highlightAndRenderCode(editor.value); // Use the fixed highlighting function
        generateLineNumbers();
        updateStatus();
    });
    editorOuter.addEventListener('scroll', syncScroll);
    editor.addEventListener('keyup', updateStatus);
    editor.addEventListener('click', updateStatus);

    // ----- File I/O -----
    document.getElementById('open-file').onclick = () => {
        document.getElementById('file-input').click();
    };
    document.getElementById('file-input').addEventListener('change', e => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = function(ev) {
            currentFileName = file.name;
            currentFileType = detectLanguage(file.name);

            // === [FIX] Update language class for Prism on the <code> element
            highlightedCode.className = 'language-' + currentFileType; // Directly set class for the <code> tag

            renderEditor(ev.target.result);
            statusFile.textContent = currentFileName;
            historyStack = [ev.target.result]; // Initialize history with the loaded content
            redoStack = [];
        };
        reader.readAsText(file);
    });

    document.getElementById('save-file').onclick = () => {
        if (!currentFileName) {
            saveAsFile();
            return;
        }
        const blob = new Blob([editor.value], {
            type: 'text/plain'
        });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = currentFileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(a.href);
    };

    function saveAsFile() {
        const fname = prompt('Enter file name', currentFileName || 'code.html');
        if (fname) {
            currentFileName = fname;
            currentFileType = detectLanguage(fname);

            // === [FIX] Update language class for Prism on the <code> element
            highlightedCode.className = 'language-' + currentFileType; // Directly set class for the <code> tag

            statusFile.textContent = currentFileName;
            document.getElementById('save-file').click();
        }
    }
    document.getElementById('save-as').onclick = saveAsFile;

    // ----- Beautify -----
    document.getElementById('btn-beautify').onclick = () => {
        try {
            let beautifiedCode = editor.value;
            if (currentFileType === 'javascript') {
                beautifiedCode = js_beautify(editor.value);
            } else if (currentFileType === 'html') {
                beautifiedCode = html_beautify(editor.value);
            } else if (currentFileType === 'css') {
                beautifiedCode = css_beautify(editor.value);
            }
            renderEditor(beautifiedCode);
            pushHistory();
        } catch (e) {
            alert('Beautify error: ' + e.message + ' (Note: Beautifier functions are currently stubs.)');
        }
    };

    // ----- Undo/Redo -----
    document.getElementById('btn-undo').onclick = undo;
    document.getElementById('btn-redo').onclick = redo;

    // ----- HTML Preview -----
    function renderHTML() {
        try {
            const blob = new Blob([editor.value], {
                type: 'text/html'
            });
            previewContent.src = URL.createObjectURL(blob);
            previewPanel.style.display = 'flex';
        } catch (e) {
            alert('Error rendering HTML. Check for syntax errors. ' + e.message);
        }
    }
    document.getElementById('btn-render').onclick = renderHTML;
    document.getElementById('render-html').onclick = renderHTML;
    document.getElementById('close-preview').onclick = () => {
        previewPanel.style.display = 'none';
        if (previewContent.src.startsWith('blob:')) {
            URL.revokeObjectURL(previewContent.src);
        }
    };

    // ----- AI -----
    function runAI() {
        const promptInput = document.getElementById('prompt-input');
        const prompt = promptInput.value.trim();
        if (!prompt) return;

        aiResponseContent.textContent = 'Processing...';
        aiResponsePanel.style.display = 'block';

        // Simulate AI response
        setTimeout(() => {
            let r = '';
            if (prompt.toLowerCase().includes('explain')) r = `This is ${currentFileType} code with ${editor.value.split('\n').length} lines.`;
            else if (prompt.toLowerCase().includes('optimize')) r = 'Consider minifying and checking dependencies for better performance. For example, remove unused CSS rules, compress images, or debounce event handlers.';
            else if (prompt.toLowerCase().includes('comment')) r = 'Add clear and concise comments, especially for complex logic, functions, or tricky parts of the code. For example: `// This function handles user authentication`';
            else if (prompt.toLowerCase().includes('bug')) r = 'To fix bugs, I would need more context, such as error messages, expected behavior, and reproduction steps. General advice: check console logs, review recent changes, and simplify the problematic section.';
            else r = `Prompt received: "${prompt}". This is a placeholder response. In a real AI integration, I would process your request and provide a more detailed analysis or code suggestion based on the editor content.`;
            aiResponseContent.textContent = r;
            promptInput.value = ''; // Clear prompt input after sending
        }, 1000); // Simulate network latency
    }
    document.getElementById('send-button').onclick = runAI;
    document.getElementById('run-local-ai').onclick = runAI;
    document.getElementById('prompt-input').addEventListener('keydown', e => {
        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
            e.preventDefault();
            runAI();
        }
    });
    document.getElementById('close-ai-panel').onclick = () => {
        aiResponsePanel.style.display = 'none';
    };

    // ----- Left Panel Toggle -----
    document.getElementById('left-toggle').onclick = () => {
        const isClosed = leftPanel.classList.toggle('closed');
        editorStage.classList.toggle('left-panel-closed', isClosed);
        document.getElementById('left-toggle').textContent = isClosed ? '☰' : '✕';
    };
    // Initialize toggle state on load for the left panel (it starts open)
    document.getElementById('left-toggle').textContent = '✕';
    leftPanel.classList.remove('closed'); // Ensure it starts open
    editorStage.classList.remove('left-panel-closed'); // Ensure grid is 240px 1fr

    // ----- Init -----
    // Initial render of the default content
    renderEditor(editor.value);
    pushHistory(); // Push initial state to history
</script>
</body>
</html>
