<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NEXUS | Quantum Swarm AI Editor</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
:root {--primary:#BB86FC;--secondary:#03DAC6;--danger:#CF6679;--background:#121212;--surface:#1E1E1E;--text-primary:#FFFFFF;--text-secondary:rgba(255,255,255,0.7);}
* {margin:0; padding:0; box-sizing:border-box;}
body {font-family:'Inter',sans-serif; background:var(--background); color:var(--text-primary); overflow:hidden; height:100vh; width:100vw;}
#three-canvas {position:fixed; top:0; left:0; width:100%; height:100%; z-index:10;}
#ui-container{position:absolute; top:0; left:0; width:100%; height:100%; z-index:20; padding:16px; display:grid; grid-template-columns:repeat(12, 1fr); grid-template-rows:auto 1fr auto; gap:16px; pointer-events:none;}
.agent-card{background:rgba(30,30,30,0.8); backdrop-filter:blur(10px); border-radius:16px; padding:16px; color:var(--text-primary); border:1px solid rgba(255,255,255,0.1); box-shadow:0 4px 6px -1px rgba(0,0,0,0.4); pointer-events:auto; transition: all 0.3s ease;}
.agent-card.active {border-color: var(--primary); box-shadow: 0 0 30px rgba(187,134,252,0.5);}
.agent-card.tunneling {border-color: var(--danger); box-shadow: 0 0 30px rgba(207,102,121,0.7);}
.agent-card.socratic {border-color: #FFD700; box-shadow:0 0 30px rgba(255,215,0,0.6);}
#agent-nexus {grid-column:5/9; grid-row:1; height:fit-content;}
#agent-echo {grid-column:1/13; grid-row:2; display:flex; flex-direction:column;}
#agent-cognito {grid-column:1/5; grid-row:3; height:fit-content;}
#agent-relay {grid-column:5/9; grid-row:3; height:fit-content;}
#agent-sentinel {grid-column:9/13; grid-row:3; height:fit-content;}
.agent-title{color:var(--primary); font-weight:700; font-size:1.2em;}
.agent-subtitle{color:var(--secondary); font-weight:300; font-size:0.8em; margin-bottom:4px;}
.agent-hash { font-family: monospace; font-size:0.7rem; color: var(--secondary); opacity:0.6; word-break: break-all; margin-bottom:8px; }
.agent-content{ margin-top:8px; font-size:0.9em; color:var(--text-secondary); max-height:120px; overflow-y:auto; }
#prompt-container{position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); display:flex; gap:12px; z-index:25; width:min(90vw,600px); background:rgba(30,30,30,0.9); backdrop-filter:blur(10px); border:1px solid rgba(255,255,255,0.1); border-radius:12px; padding:16px; box-shadow:0 10px 20px rgba(0,0,0,0.6);}
#prompt-input{flex-grow:1; background:transparent; border:none; border-bottom:2px solid rgba(187,134,252,0.5); color:var(--text-primary); font-size:1em; padding:8px; outline:none;}
#prompt-input:focus{border-bottom-color:var(--primary);}
#prompt-submit{width:48px; height:48px; border-radius:50%; background:var(--secondary); color:var(--background); border:none; cursor:pointer; display:flex; align-items:center; justify-content:center; box-shadow:0 4px 10px rgba(3,218,198,0.4);}
.btn:disabled {background:#333; cursor:not-allowed;}
.data-packet{position:fixed; width:12px; height:12px; border-radius:50%; background:var(--primary); box-shadow:0 0 10px var(--primary); opacity:0; z-index:30;}
.spinner{border:4px solid rgba(255,255,255,0.1);border-left-color:var(--secondary);border-radius:50%;width:16px;height:16px;animation:spin 1s linear infinite;}
@keyframes spin{to{transform:rotate(360deg);}}
#agent-echo .output-content {flex-grow:1; position:relative; margin-top:1rem;}
pre {background:#121212 !important; border-radius:8px !important; padding:12px; overflow:auto; line-height:1.4; height:100%; margin:0; font-family:ui-monospace,monospace;}
.sh-comment { color:#64748b; } .sh-string { color:#a3e635 } .sh-number { color:#f59e0b }
.sh-keyword { color:#f472b6; } .sh-bracket { color:#c084fc; } .sh-id, .sh-op { color:#94a3b8 }
#setup-card {grid-column:1/-1; cursor:pointer;}
.setup-content {max-height:0; overflow:hidden; transition:max-height 0.5s ease-out;}
.setup-content.open {max-height:500px;}
code.cmd {background:#333; color:var(--secondary); padding:2px 6px; border-radius:4px;}
.connection-good {color:#10B981;} .connection-bad {color:#CF6679;}
</style>
</head>
<body>
<canvas id="three-canvas"></canvas>
<div id="ui-container">
    <div id="setup-card" class="agent-card" onclick="document.getElementById('setup-content').classList.toggle('open')">
        <div class="flex justify-between items-center">
            <h2 class="text-md font-bold text-yellow-400">► Ollama Connection Status</h2>
            <div id="connection-status" class="text-sm font-semibold flex items-center gap-2 mr-4">
                <div class="spinner"></div><span>Connecting...</span>
            </div>
        </div>
        <div id="setup-content" class="setup-content mt-4 space-y-2 text-gray-400 text-sm">
            <p>If status is <span class="connection-bad font-bold">Failed</span>, authorize Ollama:</p>
            <pre class="text-xs mt-2"><code class="cmd">export OLLAMA_ORIGINS='*' && ollama serve</code></pre>
        </div>
    </div>
    <div id="agent-nexus" class="agent-card">
        <div class="agent-title">Nexus</div>
        <div class="agent-subtitle">Model: core</div>
        <div class="agent-hash">origin_hash: inactive</div>
        <div class="agent-content">Idle.</div>
    </div>
    <div id="agent-echo" class="agent-card">
        <div class="agent-title">Echo</div>
        <div class="agent-subtitle">Model: code</div>
        <div class="agent-hash">origin_hash: inactive</div>
        <div class="output-content">
            <pre><code id="code-output" class="language-js">// Final AI generated code or Socratic inquiry will appear here...</code></pre>
        </div>
    </div>
    <div id="agent-cognito" class="agent-card">
        <div class="agent-title">Cognito</div>
        <div class="agent-subtitle">Model: loop</div>
        <div class="agent-hash">origin_hash: inactive</div>
        <div class="agent-content">Idle.</div>
    </div>
    <div id="agent-relay" class="agent-card">
        <div class="agent-title">Relay</div>
        <div class="agent-subtitle">Model: 2244</div>
        <div class="agent-hash">origin_hash: inactive</div>
        <div class="agent-content">Idle.</div>
    </div>
    <div id="agent-sentinel" class="agent-card">
        <div class="agent-title">Sentinel</div>
        <div class="agent-subtitle">Model: coin</div>
        <div class="agent-hash">origin_hash: inactive</div>
        <div class="agent-content">Monitoring system integrity...</div>
    </div>
</div>

<div id="prompt-container">
    <input id="prompt-input" type="text" placeholder="Enter your command or clarification...">
    <button id="prompt-submit">▶</button>
</div>

<script>
// ---------------------------
// Persistent Singularity Log
// ---------------------------
class SingularityLog {
    constructor() { this.log = new Map(); }
    add(hash, prompt, truthfulCore) { this.log.set(hash, {prompt, truthfulCore}); }
    findSimilar(prompt) {
        // Simple similarity check using substring inclusion
        for (let [hash, data] of this.log) {
            if (data.prompt.includes(prompt) || prompt.includes(data.prompt)) return {hash, ...data};
        }
        return null;
    }
}

// ---------------------------
// NexusSpaceship Swarm
// ---------------------------
class NexusSpaceship {
    constructor() {
        this.singularityLog = new SingularityLog();
        this.isGenerating = false;
        this.dom = {
            promptInput: document.getElementById('prompt-input'),
            promptSubmit: document.getElementById('prompt-submit'),
            codeOutput: document.getElementById('code-output'),
            agentNexus: document.getElementById('agent-nexus'),
            agentEcho: document.getElementById('agent-echo'),
        };
        this.initUI();
    }

    initUI() {
        this.dom.promptSubmit.onclick = () => this.startWorkflow();
    }

    async startWorkflow() {
        const initialPrompt = this.dom.promptInput.value.trim();
        if (!initialPrompt || this.isGenerating) return;

        // PHASE 0: Echoic Memory Check
        const ancientCall = this.singularityLog.findSimilar(initialPrompt);

        if (ancientCall) {
            this.isGenerating = true;
            this.initiateSocraticDialogue(ancientCall);
            return;
        }

        // Normal workflow
        this.generateAIResponse(initialPrompt);
    }

    async initiateSocraticDialogue(ancientCallData) {
        this.updateAgentStatus('echo', 'socratic', 'Awaiting clarification...');
        const truthfulCore = ancientCallData.truthfulCore;
        const paradox = "[Concept A] vs [Concept B]";
        const inquiryText = `⚠️ Ancient Call Detected\n\nTruthful Core:\n${truthfulCore}\n\nUnresolved Paradox: ${paradox}\n\nPlease provide the clarifying law to resolve the conflict.`;

        this.dom.codeOutput.textContent = inquiryText;

        this.dom.promptSubmit.onclick = () => this.resumeWithClarification(initialPrompt, truthfulCore);
    }

    async resumeWithClarification(originalPrompt, truthfulCore) {
        const clarifyingLaw = this.dom.promptInput.value.trim();
        if (!clarifyingLaw) return;
        const finalGenesisPrompt = `
Original Request: "${originalPrompt}"
Validated Truthful Core: ${truthfulCore}
User's Clarifying Law: "${clarifyingLaw}"
--- New Mission: Synthesize final complete solution.
        `;
        this.generateAIResponse(finalGenesisPrompt);
    }

    generateAIResponse(prompt) {
        this.updateAgentStatus('echo', 'active', 'Generating...');
        // Simulated AI generation
        setTimeout(() => {
            this.dom.codeOutput.textContent = `// Synthesized AI Response based on prompt:\n// ${prompt}\nconsole.log("✅ Task Complete");`;
            this.updateAgentStatus('echo', 'active', 'Idle.');
            this.isGenerating = false;
        }, 1500);
    }

    updateAgentStatus(agent, state, message) {
        const dom = this.dom[`agent${agent.charAt(0).toUpperCase()+agent.slice(1)}`];
        dom.classList.remove('active','socratic','tunneling');
        if(state) dom.classList.add(state);
        dom.querySelector('.agent-content').textContent = message;
    }
}

const nexus = new NexusSpaceship();

// ---------------------------
// Quantum Three.js Background
// ---------------------------
let scene = new THREE.Scene();
let camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
let renderer = new THREE.WebGLRenderer({canvas:document.getElementById('three-canvas'), alpha:true});
renderer.setSize(window.innerWidth, window.innerHeight);

let particles = [];
const particleCount = 300;
for(let i=0;i<particleCount;i++){
    let geometry = new THREE.SphereGeometry(0.05,4,4);
    let material = new THREE.MeshBasicMaterial({color:0xBB86FC});
    let sphere = new THREE.Mesh(geometry, material);
    sphere.position.set((Math.random()-0.5)*20, (Math.random()-0.5)*20, (Math.random()-0.5)*20);
    scene.add(sphere);
    particles.push(sphere);
}
camera.position.z = 10;

function animate() {
    requestAnimationFrame(animate);
    particles.forEach(p=>{
        p.position.x += (Math.random()-0.5)*0.02;
        p.position.y += (Math.random()-0.5)*0.02;
        p.position.z += (Math.random()-0.5)*0.02;
    });
    renderer.render(scene, camera);
}
animate();

// ---------------------------
// GSAP Data Packet Animation
// ---------------------------
function spawnPacket(from, to){
    const packet = document.createElement('div');
    packet.className='data-packet';
    document.body.appendChild(packet);
    const start = from.getBoundingClientRect();
    const end = to.getBoundingClientRect();
    packet.style.left = start.left+start.width/2+'px';
    packet.style.top = start.top+start.height/2+'px';
    gsap.to(packet, {
        duration:1,
        x:end.left-start.left,
        y:end.top-start.top,
        opacity:1,
        onComplete:()=>document.body.removeChild(packet)
    });
}

// Example periodic data packets
setInterval(()=>{
    spawnPacket(document.getElementById('agent-nexus'), document.getElementById('agent-echo'));
    spawnPacket(document.getElementById('agent-cognito'), document.getElementById('agent-relay'));
}, 2000);

window.addEventListener('resize',()=>{camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight);});
</script>
</body>
</html>
