<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nemodian 2244-1 :: Singlefile Offline AI Editor</title>
    <style>
        /* ----- :root Variables ----- */
        :root {
            --muted: #888;
            --info: #2196F3;
            --warn: #FF9800;
            --error: #F44336;
            --success: #4CAF50;
            --baseline: 1.5em;
            --header-h: calc(var(--baseline) * 1.6);
            --status-h: var(--baseline);
            --footer-h: calc(var(--baseline) * 2);
            --font-size: 13px;
            --ln-width: 50px;
            --theme-bg: #3a3c31;
            --panel: #313328;
            --header-bg: #2e3026;
            --status-bg: #22241e;
            --accent: #4ac94a;
            --muted-text: #999966;
            --err: #a03333;
            --warn-bg: #f0ad4e;
            --hover-blue: #3366a0;
            --info-bg: #5bc0de;
        }

        /* ----- Base ----- */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            font-family: 'Fira Code', monospace;
            font-size: var(--font-size);
            line-height: var(--baseline);
            background: var(--theme-bg);
            color: #f0f0e0;
            overflow: hidden;
        }

        body {
            display: grid;
            grid-template-rows: var(--header-h) var(--status-h) 1fr var(--footer-h);
        }

        /* ----- Header ----- */
        header {
            grid-row: 1;
            grid-column: 1 / -1;
            background: var(--header-bg);
            border-bottom: 1px solid #22241e;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
        }

        header .left,
        header .right {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        /* ----- Buttons ----- */
        button {
            background: var(--err);
            border: 1px solid var(--err);
            color: #f0f0e0;
            padding: 6px 8px;
            cursor: pointer;
            font-size: 12px;
            transition: all .2s;
            border-radius: 3px;
        }

        button:hover {
            background: var(--hover-blue);
            border-color: var(--hover-blue);
        }

        button.success {
            background: var(--accent);
            border-color: var(--accent);
        }

        button.info {
            background: var(--info-bg);
            border-color: var(--info-bg);
        }

        button.warn {
            background: var(--warn-bg);
            border-color: var(--warn-bg);
            color: #3a3c31;
        }

        .small {
            font-size: 12px;
            padding: 6px 8px;
        }

        /* ----- Status Bar ----- */
        #status-bar {
            grid-row: 2;
            grid-column: 1 / -1;
            background: var(--status-bg);
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 4px 12px;
            font-size: 12px;
        }

        #status-bar.error {
            background: var(--err);
            color: #f0f0e0;
        }

        #status-bar.warn {
            background: var(--warn-bg);
            color: #3a3c31;
        }

        #status-bar.success {
            background: var(--accent);
            color: #3a3c31;
        }

        #status-bar.info {
            background: var(--info-bg);
            color: #3a3c31;
        }


        /* ----- Editor Stage ----- */
        #editor-stage {
            grid-row: 3;
            grid-column: 1 / -1;
            /* Changed to single column layout */
            display: grid;
            grid-template-columns: 1fr;
            background: var(--theme-bg);
            overflow: hidden;
            position: relative;
        }

        #left-panel {
            width: 240px;
            background: var(--panel);
            border-right: 1px solid #22241e;
            padding: 10px;
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            gap: 8px;
            /* Changed for slide-out logic */
            position: absolute;
            height: 100%;
            z-index: 30;
            transition: transform 0.3s ease;
            transform: translateX(-240px); /* Hidden by default */
        }

        /* This class is toggled by JS to show the panel */
        #left-panel.open {
            transform: translateX(0);
        }

        #editor-outer {
            position: relative;
            overflow: hidden;
            background: transparent;
            /* Added padding for new layout */
            padding-left: 1em;
            box-sizing: border-box;
        }

        #line-gutter {
            position: absolute;
            left: 1em; /* Respects parent padding */
            top: 0;
            bottom: 0;
            width: var(--ln-width);
            background: var(--panel);
            color: var(--muted-text);
            padding: 10px 8px;
            box-sizing: border-box;
            overflow: hidden;
            font-variant-numeric: tabular-nums;
            text-align: right;
            user-select: none;
        }

        .highlighting {
            position: absolute;
            left: 1em; /* Respects parent padding */
            right: 0;
            top: 0;
            bottom: 0;
            pointer-events: none;
            overflow: hidden; /* FIX: Prevents double scrollbar */
            padding: 10px;
            box-sizing: border-box;
            white-space: pre-wrap;
            word-break: break-word;
            line-height: var(--baseline);
            padding-left: calc(var(--ln-width) + 12px);
            font-family: 'Fira Code', monospace; /* FIX: Explicitly set font */
        }

        .highlighting pre {
            margin: 0;
        }

        #editor {
            position: absolute;
            left: calc(1em + var(--ln-width)); /* Respects parent padding */
            right: 0;
            top: 0;
            bottom: 0;
            padding: 10px;
            margin: 0;
            box-sizing: border-box;
            overflow: auto;
            background: transparent;
            color: transparent;
            caret-color: var(--accent);
            font-family: 'Fira Code', monospace; /* FIX: Explicitly set font */
            font-size: var(--font-size);
            line-height: var(--baseline);
            border: 0;
            outline: 0;
            resize: none;
            white-space: pre-wrap;
            word-break: break-word;
            z-index: 20;
            padding-left: 12px;
        }

        /* ----- Footer ----- */
        footer {
            grid-row: 4;
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 6px 12px;
            background: var(--header-bg);
            border-top: 1px solid #22241e;
        }

        #prompt-input {
            flex: 1;
            margin-right: 8px;
            padding: 8px;
            background: var(--status-bg);
            border: 1px solid var(--accent);
            color: #f0f0e0;
            font-family: inherit;
            border-radius: 3px;
        }

        /* ----- Panels (Preview, AI) ----- */
        #preview-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80%;
            height: 80%;
            background: white;
            border: 2px solid var(--accent);
            border-radius: 5px;
            z-index: 1000;
            display: none;
            flex-direction: column;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.7);
        }

        #preview-header {
            background: var(--header-bg);
            color: #f0f0e0;
            padding: 8px 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--accent);
        }

        #preview-content {
            width: 100%;
            height: calc(100% - 40px);
            border: none;
            background: white;
        }

        #close-preview {
            background: transparent;
            border: none;
            color: #f0f0e0;
            font-size: 18px;
            cursor: pointer;
            padding: 0;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        #ai-response-panel {
            position: fixed;
            bottom: 60px;
            right: 20px;
            width: 400px;
            max-height: 300px;
            background: var(--panel);
            border: 1px solid var(--accent);
            border-radius: 5px;
            padding: 10px;
            overflow-y: auto;
            z-index: 100;
            display: none;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            white-space: pre-wrap; /* Allow wrapping in AI panel */
        }

        #ai-response-content {
            font-size: 12px;
            line-height: 1.4;
        }

        #close-ai-panel {
            position: absolute;
            top: 5px;
            right: 5px;
            background: transparent;
            border: none;
            color: var(--muted-text);
            font-size: 14px;
            cursor: pointer;
        }


        /* ----- Misc ----- */
        #file-input {
            display: none;
        }

        .ai-status {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .ai-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--err);
            animation: pulse 2s infinite;
        }

        .ai-dot.connected {
            background: var(--accent);
            animation: none;
        }

        @keyframes pulse {
            0% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }

            100% {
                opacity: 1;
            }
        }

        /* ----- Responsive ----- */
        /* Removed media query, as slide-out panel is now default */
        @media (max-width: 768px) {
            #ai-response-panel {
                width: calc(100% - 40px);
                right: 20px;
                left: 20px;
            }

            #preview-panel {
                width: 95%;
                height: 85%;
            }
        }
    </style>
</head>
<body>
    <!-- HTML Structure Remains Unchanged -->
    <header>
        <div class="left">
            <button id="left-toggle" class="small">☰</button>
            <div style="font-weight:800;">Nemodian 2244-1 :: AI Editor</div>
        </div>
        <div class="right">
            <div class="ai-status">
                <div class="ai-dot"></div>
                <div id="ai-indicator" style="font-size:12px;color:#cfcfbd;">Local AI: probing…</div>
            </div>
            <button id="open-file" class="small">Open</button>
            <button id="save-file" class="small">Save</button>
            <button id="save-as" class="small">Save As</button>
            <button id="render-html" class="small warn">Render HTML</button>
            <button id="run-local-ai" class="small info">Run AI</button>
        </div>
    </header>
    <div id="status-bar" class="info">
        <div id="file-meta">No File Loaded</div>
        <div id="editor-meta">Cursor: 0:0 | Lines: 0 | Chars: 0 | History: 0</div>
    </div>
    <div id="editor-stage">
        <aside id="left-panel">
            <button id="btn-undo" class="small">UNDO</button>
            <button id="btn-redo" class="small">REDO</button>
            <button id="btn-beautify" class="small">Beautify</button>
            <button id="btn-render" class="small warn">Render HTML</button>
            <div style="margin-top: 20px; font-size: 11px; color: var(--muted-text);">
                <p><strong>AI Commands:</strong></p>
                <ul style="padding-left: 15px;">
                    <li>Explain this code</li>
                    <li>Optimize this function</li>
                    <li>Add comments</li>
                    <li>Fix bugs</li>
                </ul>
            </div>
            <div style="margin-top: 20px; font-size: 11px; color: var(--muted-text);">
                <p><strong>HTML Render:</strong></p>
                <p>Click "Render HTML" to preview your HTML code in a live browser view.</p>
            </div>
        </aside>
        <div id="editor-outer">
            <div id="line-gutter"></div>
            <div class="highlighting">
                <pre><code id="highlighted" class="language-html"></code></pre>
            </div>
            <textarea id="editor" spellcheck="false">&lt;!DOCTYPE html&gt;
&lt;html lang="en"&gt;
&lt;head&gt;
  &lt;meta charset="UTF-8"&gt;
  &lt;meta name="viewport" content="width=device-width, initial-scale=1.0"&gt;
  &lt;title&gt;Nemodian 2244-1 Demo&lt;/title&gt;
  &lt;style&gt;
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d);
      color: white;
      margin: 0;
      padding: 20px;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    .container {
      background: rgba(0, 0, 0, 0.7);
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
      max-width: 600px;
      text-align: center;
    }
    h1 {
      font-size: 2.5rem;
      margin-bottom: 10px;
      background: linear-gradient(90deg, #4ac94a, #5bc0de);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    p {
      font-size: 1.2rem;
      line-height: 1.6;
    }
  &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
  &lt;div class="container"&gt;
    &lt;h1&gt;Welcome to Nemodian 2244-1&lt;/h1&gt;
    &lt;p&gt;This is a demonstration of the offline AI editor's capabilities. You can edit this HTML and CSS, and then click "Render HTML" to see your changes.&lt;/p&gt;
  &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;
</textarea>
        </div>
    </div>
    <footer>
        <input id="prompt-input" placeholder="AI Prompt (Ctrl+Enter to run)">
        <button id="send-button" class="success">SEND</button>
    </footer>
    <input type="file" id="file-input" accept=".js,.html,.css,.txt,.json">
    <div id="preview-panel">
        <div id="preview-header">
            <span>HTML Preview</span>
            <button id="close-preview">×</button>
        </div>
        <iframe id="preview-content"></iframe>
    </div>
    <div id="ai-response-panel">
        <button id="close-ai-panel">×</button>
        <div id="ai-response-content"></div>
    </div>

    <!-- Dummy Libraries for standalone functionality -->
    <script>
        /* PRISM + JS + CSS + HTML + JSON highlighting */
        // These are dummy functions for the standalone demo
        window.Prism = {
            languages: {
                javascript: {},
                html: {},
                css: {},
                json: {}
            },
            highlightAll: () => { /* Dummy */ }
        };

        function js_beautify(code) {
            console.warn("js_beautify is a dummy function.");
            return code;
        }

        function css_beautify(code) {
            console.warn("css_beautify is a dummy function.");
            return code;
        }

        function html_beautify(code) {
            console.warn("html_beautify is a dummy function.");
            return code;
        }
    </script>
    <script>
        // ----- App Logic (Encapsulated) -----
        (function() {
            'use strict';

            const AIEditor = {
                // --- Application State ---
                state: {
                    currentFileName: null,
                    currentFileType: 'html',
                    historyStack: [],
                    redoStack: []
                },

                // --- DOM Element Cache ---
                elements: {
                    editor: document.getElementById('editor'),
                    highlighted: document.getElementById('highlighted'),
                    lineGutter: document.getElementById('line-gutter'),
                    statusEditor: document.getElementById('editor-meta'),
                    statusFile: document.getElementById('file-meta'),
                    previewPanel: document.getElementById('preview-panel'),
                    previewContent: document.getElementById('preview-content'),
                    aiResponsePanel: document.getElementById('ai-response-panel'),
                    aiResponseContent: document.getElementById('ai-response-content'),
                    leftPanel: document.getElementById('left-panel'),
                    fileInput: document.getElementById('file-input'),
                    promptInput: document.getElementById('prompt-input'),
                    aiIndicator: document.getElementById('ai-indicator'),
                    aiDot: document.querySelector('.ai-dot'),
                },

                // --- Initialization ---
                init() {
                    this.editor.init(this); // Pass parent reference
                    this.history.init(this);
                    this.file.init(this);
                    this.ui.init(this);
                    this.ai.init(this); // Pass parent reference

                    this.bindEvents();
                    this.editor.render(this.elements.editor.value);
                    this.history.push(this.elements.editor.value, true); // Push initial state
                    this.ai.checkAIConnection(); // Check for Ollama on boot
                },

                // --- Event Binding ---
                bindEvents() {
                    this.elements.editor.addEventListener('input', () => this.editor.onInput());
                    this.elements.editor.addEventListener('scroll', () => this.editor.syncScroll());
                    this.elements.editor.addEventListener('keyup', () => this.editor.updateStatus());
                    this.elements.editor.addEventListener('click', () => this.editor.updateStatus());

                    document.getElementById('open-file').onclick = () => this.file.open();
                    this.elements.fileInput.addEventListener('change', e => this.file.handleOpen(e));
                    document.getElementById('save-file').onclick = () => this.file.save();
                    document.getElementById('save-as').onclick = () => this.file.saveAs();

                    // --- Sidebar Button Bindings (with close panel logic) ---
                    document.getElementById('btn-beautify').onclick = () => {
                        this.editor.beautify();
                        this.ui.closeLeftPanel();
                    };
                    document.getElementById('btn-undo').onclick = () => {
                        this.editor.undo();
                        this.ui.closeLeftPanel();
                    };
                    document.getElementById('btn-redo').onclick = () => {
                        this.editor.redo();
                        this.ui.closeLeftPanel();
                    };
                    document.getElementById('btn-render').onclick = () => {
                        this.ui.renderHTML();
                        this.ui.closeLeftPanel();
                    };
                    // --- End Sidebar Button Bindings ---

                    document.getElementById('render-html').onclick = () => this.ui.renderHTML();
                    document.getElementById('close-preview').onclick = () => this.ui.closePreview();

                    document.getElementById('send-button').onclick = () => this.ai.run();
                    document.getElementById('run-local-ai').onclick = () => this.ai.run();
                    this.elements.promptInput.addEventListener('keydown', e => this.ai.handleKeydown(e));
                    document.getElementById('close-ai-panel').onclick = () => this.ui.closeAIPanel();

                    // Main sidebar toggle
                    document.getElementById('left-toggle').onclick = () => this.ui.toggleLeftPanel();
                },

                // ===================================
                // ---       EDITOR MODULE         ---
                // ===================================
                editor: {
                    init(parent) {
                        this.parent = parent;
                    },

                    onInput() {
                        this.parent.history.push(this.parent.elements.editor.value);
                        this.highlightAndRender(this.parent.elements.editor.value);
                        this.generateLineNumbers();
                        this.updateStatus();
                    },

                    render(code) {
                        this.parent.elements.editor.value = code;
                        this.highlightAndRender(code);
                        this.generateLineNumbers();
                        this.updateStatus();
                    },

                    highlightAndRender(code) {
                        this.parent.elements.highlighted.textContent = code;
                        // In a real scenario, you'd use a library like Prism.js here
                        Prism.highlightAll(); // Call dummy
                    },

                    generateLineNumbers() {
                        this.parent.elements.lineGutter.innerHTML = this.parent.elements.editor.value.split('\n').map((_, i) => i + 1).join('<br>');
                    },

                    updateStatus() {
                        const editor = this.parent.elements.editor;
                        const pos = editor.selectionStart;
                        const lines = editor.value.substr(0, pos).split('\n');
                        const lineCount = editor.value.split('\n').length;
                        this.parent.elements.statusEditor.textContent = `Cursor: ${lines.length}:${lines[lines.length - 1].length} | Lines: ${lineCount} | Chars: ${editor.value.length} | History: ${this.parent.state.historyStack.length}`;
                    },

                    syncScroll() {
                        const editor = this.parent.elements.editor;
                        // The scrollable parent is .highlighting
                        this.parent.elements.highlighted.parentElement.scrollTop = editor.scrollTop;
                        this.parent.elements.highlighted.parentElement.scrollLeft = editor.scrollLeft;
                        this.parent.elements.lineGutter.scrollTop = editor.scrollTop;
                    },

                    beautify() {
                        try {
                            let beautifiedCode = this.parent.elements.editor.value;
                            const fileType = this.parent.state.currentFileType;
                            if (fileType === 'javascript') {
                                beautifiedCode = js_beautify(beautifiedCode);
                            } else if (fileType === 'html') {
                                beautifiedCode = html_beautify(beautifiedCode);
                            } else if (fileType === 'css') {
                                beautifiedCode = css_beautify(beautifiedCode);
                            }
                            this.render(beautifiedCode);
                            this.parent.history.push(beautifiedCode);
                        } catch (e) {
                            alert('Beautify error: Make sure the code is valid.');
                        }
                    },

                    undo() {
                        this.parent.history.undo();
                    },
                    redo() {
                        this.parent.history.redo();
                    }
                },

                // ===================================
                // ---       HISTORY MODULE        ---
                // ===================================
                history: {
                    init(parent) {
                        this.parent = parent;
                    },

                    push(code, isInitial = false) {
                        const historyStack = this.parent.state.historyStack;
                        if (!isInitial && historyStack.length && historyStack[historyStack.length - 1] === code) return;
                        historyStack.push(code);
                        this.parent.state.redoStack = [];
                        this.parent.editor.updateStatus();
                    },

                    undo() {
                        const {
                            historyStack,
                            redoStack
                        } = this.parent.state;
                        if (historyStack.length > 1) { // Keep at least one state (initial)
                            redoStack.push(historyStack.pop());
                            this.parent.editor.render(historyStack[historyStack.length - 1]);
                        }
                    },

                    redo() {
                        const {
                            historyStack,
                            redoStack
                        } = this.parent.state;
                        if (redoStack.length) {
                            const nextState = redoStack.pop();
                            historyStack.push(nextState);
                            this.parent.editor.render(nextState);
                        }
                    }
                },

                // ===================================
                // ---         FILE MODULE         ---
                // ===================================
                file: {
                    init(parent) {
                        this.parent = parent;
                    },

                    open() {
                        this.parent.elements.fileInput.click();
                    },

                    handleOpen(e) {
                        const file = e.target.files[0];
                        if (!file) return;
                        const reader = new FileReader();
                        reader.onload = (ev) => {
                            const newCode = ev.target.result;
                            this.parent.state.currentFileName = file.name;
                            this.parent.state.currentFileType = this.detectLanguage(file.name);
                            this.parent.editor.render(newCode);
                            this.parent.elements.statusFile.textContent = file.name;
                            // Reset history with new file content
                            this.parent.state.historyStack = [newCode];
                            this.parent.state.redoStack = [];
                            this.parent.editor.updateStatus();
                        };
                        reader.readAsText(file);
                    },

                    save() {
                        if (!this.parent.state.currentFileName) {
                            this.saveAs();
                            return;
                        }
                        this.download(this.parent.state.currentFileName, this.parent.elements.editor.value);
                    },

                    saveAs() {
                        const fname = prompt('Enter file name', this.parent.state.currentFileName || 'code.html');
                        if (fname) {
                            this.parent.state.currentFileName = fname;
                            this.parent.state.currentFileType = this.detectLanguage(fname);
                            this.parent.elements.statusFile.textContent = fname;
                            this.save();
                        }
                    },

                    download(filename, text) {
                        const blob = new Blob([text], {
                            type: 'text/plain'
                        });
                        const a = document.createElement('a');
                        a.href = URL.createObjectURL(blob);
                        a.download = filename;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        URL.revokeObjectURL(a.href);
                    },

                    detectLanguage(fname) {
                        const ext = fname?.split('.').pop().toLowerCase();
                        return {
                            'js': 'javascript',
                            'html': 'html',
                            'htm': 'html',
                            'css': 'css',
                            'json': 'json'
                        } [ext] || 'html';
                    }
                },

                // ===================================
                // ---          UI MODULE          ---
                // ===================================
                ui: {
                    init(parent) {
                        this.parent = parent;
                    },

                    renderHTML() {
                        try {
                            // Revoke old blob URL if it exists
                            if (this.parent.elements.previewContent.src.startsWith('blob:')) {
                                URL.revokeObjectURL(this.parent.elements.previewContent.src);
                            }
                            const blob = new Blob([this.parent.elements.editor.value], {
                                type: 'text/html'
                            });
                            this.parent.elements.previewContent.src = URL.createObjectURL(blob);
                            this.parent.elements.previewPanel.style.display = 'flex';
                        } catch (e) {
                            alert('Error rendering HTML. Check for syntax errors.');
                        }
                    },

                    closePreview() {
                        this.parent.elements.previewPanel.style.display = 'none';
                        if (this.parent.elements.previewContent.src.startsWith('blob:')) {
                            URL.revokeObjectURL(this.parent.elements.previewContent.src);
                        }
                    },

                    closeAIPanel() {
                        this.parent.elements.aiResponsePanel.style.display = 'none';
                    },

                    toggleLeftPanel() {
                        this.parent.elements.leftPanel.classList.toggle('open');
                    },

                    closeLeftPanel() {
                        this.parent.elements.leftPanel.classList.remove('open');
                    }
                },

                // ===================================
                // ---          AI MODULE          ---
                // ===================================
                ai: {
                    init(parent) {
                        this.parent = parent;
                        this.OLLAMA_URL = 'http://localhost:11434';
                        this.OLLAMA_MODEL = 'llama3:8b'; // Or any model you have
                        this.ndjsonBuffer = ''; // Buffer for processing NDJSON stream
                    },

                    /**
                     * Sets the visual status of the AI connection.
                     */
                    setAIStatus(isConnected) {
                        if (isConnected) {
                            this.parent.elements.aiIndicator.textContent = 'Local AI: Online';
                            this.parent.elements.aiDot.classList.add('connected');
                        } else {
                            this.parent.elements.aiIndicator.textContent = 'Local AI: Offline';
                            this.parent.elements.aiDot.classList.remove('connected');
                        }
                    },

                    /**
                     * Checks if the Ollama server is running.
                     */
                    async checkAIConnection() {
                        try {
                            const response = await fetch(this.OLLAMA_URL, {
                                method: 'GET'
                            });
                            if (response.status === 200) {
                                this.setAIStatus(true);
                            } else {
                                this.setAIStatus(false);
                            }
                        } catch (e) {
                            this.setAIStatus(false);
                        }
                    },

                    /**
                     * Runs the AI prompt. This is the main entry point.
                     */
                    async run() {
                        const prompt = this.parent.elements.promptInput.value.trim();
                        if (!prompt) return;

                        const code = this.parent.elements.editor.value;
                        const fullPrompt = `
Here is my current ${this.parent.state.currentFileType} code:
\`\`\`${this.parent.state.currentFileType}
${code}
\`\`\`

My request is: "${prompt}"
`;

                        this.parent.elements.aiResponseContent.textContent = 'Processing...';
                        this.parent.elements.aiResponsePanel.style.display = 'block';
                        this.ndjsonBuffer = ''; // Clear buffer for new stream

                        try {
                            await this.streamOllamaResponse(fullPrompt);
                        } catch (e) {
                            this.parent.elements.aiResponseContent.textContent = `Error: ${e.message}. \n\nIs Ollama running at ${this.OLLAMA_URL}?`;
                            console.error("Ollama error:", e);
                            this.setAIStatus(false);
                        }
                    },

                    /**
                     * Handles the streaming fetch request to Ollama.
                     */
                    async streamOllamaResponse(fullPrompt) {
                        const payload = {
                            model: this.OLLAMA_MODEL,
                            prompt: fullPrompt,
                            stream: true // Enable streaming
                        };

                        const response = await fetch(`${this.OLLAMA_URL}/api/generate`, {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });

                        if (!response.ok) {
                            throw new Error(`Ollama request failed with status ${response.status}`);
                        }

                        const reader = response.body.getReader();
                        const decoder = new TextDecoder();
                        this.parent.elements.aiResponseContent.textContent = ''; // Clear "Processing..."

                        while (true) {
                            const {
                                value,
                                done
                            } = await reader.read();
                            if (done) {
                                break;
                            }

                            // Add the new chunk to our buffer
                            this.ndjsonBuffer += decoder.decode(value, {
                                stream: true
                            });

                            // Process all complete lines (NDJSON) in the buffer
                            let newlineIndex;
                            while ((newlineIndex = this.ndjsonBuffer.indexOf('\n')) !== -1) {
                                const line = this.ndjsonBuffer.substring(0, newlineIndex);
                                this.ndjsonBuffer = this.ndjsonBuffer.substring(newlineIndex + 1);

                                if (!line) continue; // Skip empty lines

                                try {
                                    const jsonLine = JSON.parse(line);
                                    if (jsonLine.response) {
                                        // This is a content token, append it
                                        this.parent.elements.aiResponseContent.textContent += jsonLine.response;
                                        // Auto-scroll the panel
                                        const panel = this.parent.elements.aiResponsePanel;
                                        panel.scrollTop = panel.scrollHeight;
                                    }
                                    if (jsonLine.done) {
                                        // Stream is finished
                                        return;
                                    }
                                } catch (e) {
                                    console.warn('Failed to parse JSON line:', line, e);
                                }
                            }
                        }
                    },

                    /**
                     * Handles Ctrl+Enter or Meta+Enter to run the prompt.
                     */
                    handleKeydown(e) {
                        if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                            e.preventDefault();
                            this.run();
                        }
                    }
                }
            };

            // --- Start the application ---
            document.addEventListener('DOMContentLoaded', () => {
                AIEditor.init();
            });

        })();
    </script>
</body>
</html>

